<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard (GPS)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .container { max-width: 1200px; margin-top: 30px; margin-bottom: 50px; }
        .hidden { display: none !important; }
        .nav-tabs .nav-link { cursor: pointer; color: #495057; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-bottom: 3px solid #0d6efd; }
        .profile-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .profile-thumb-lg { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; }
        .user-cell { display: flex; align-items: center; gap: 10px; }
        #calendar { background: white; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="loginPage" class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="card p-4 shadow-sm text-center" style="width: 400px;">
            <h3 class="mb-3">üè• Admin Login</h3>
            <input type="email" id="email" class="form-control mb-3" value="medlifeplus@gmail.com">
            <button onclick="sendLoginLink()" id="btnSend" class="btn btn-primary w-100">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
            <div id="loginMsg" class="mt-3 text-success small"></div>
        </div>
    </div>

    <div id="dashboardPage" class="container hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h3 class="mb-0">Admin Dashboard</h3><span class="badge bg-secondary" id="adminEmailDisplay">...</span></div>
            <button onclick="logout()" class="btn btn-sm btn-outline-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item"><a class="nav-link active" onclick="switchTab('attendance')">üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('schedule')">‚úçÔ∏è ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('leave')">üì© ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('calendar')">üóìÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('users')">üë• ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô <span id="userBadge" class="badge bg-danger hidden">New</span></a></li>
        </ul>

        <div id="tabAttendance">
            <div class="card">
                <div class="card-header bg-white py-3 d-flex gap-2 align-items-center flex-wrap">
                    <input type="date" id="filterDate" class="form-control" style="width: auto;">
                    <button onclick="loadData()" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    <button onclick="exportCSV()" class="btn btn-success ms-auto">üì• Export Excel</button>
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light"><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabSchedule" class="hidden">
            <div class="row">
                <div class="col-md-4 mb-4"><div class="card p-3"><h5>‚úçÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏£</h5><form onsubmit="createSchedule(event)"><select id="userSelect" class="form-select mb-2" required></select><input type="date" id="schedDate" class="form-control mb-2" required><select id="schedType" class="form-select mb-3"><option>‡πÄ‡∏ä‡πâ‡∏≤ (08:00 - 17:00)</option><option>‡∏ö‡πà‡∏≤‡∏¢ (13:00 - 22:00)</option><option>‡∏î‡∏∂‡∏Å (22:00 - 07:00)</option><option>‡∏´‡∏¢‡∏∏‡∏î (Day Off)</option></select><button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form></div></div>
                <div class="col-md-8"><div class="card p-3"><div class="d-flex justify-content-between mb-2"><h5>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£</h5><button onclick="loadSchedules()" class="btn btn-sm btn-outline-secondary">Refresh</button></div><table class="table table-sm table-bordered align-middle"><tbody id="schedTableBody"></tbody></table></div></div>
            </div>
        </div>

        <div id="tabLeave" class="hidden">
            <div class="card"><div class="card-header bg-warning">‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="card-body p-0 table-responsive"><table class="table table-hover mb-0 align-middle"><tbody id="leaveTableBody"></tbody></table></div></div>
        </div>

        <div id="tabCalendar" class="hidden"><div id='calendar'></div></div>

        <div id="tabUsers" class="hidden">
            <div class="row">
                <div class="col-md-6 mb-4"><div class="card border-danger"><div class="card-header bg-danger text-white"><h5>‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h5></div><div class="card-body p-0 table-responsive"><table class="table table-hover mb-0 align-middle"><tbody id="pendingUsersTable"></tbody></table></div></div></div>
                <div class="col-md-6"><div class="card"><div class="card-header bg-white d-flex justify-content-between"><h5>‚úÖ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5><button onclick="loadAllUsers()" class="btn btn-sm btn-outline-secondary">Refresh</button></div><div class="card-body p-0 table-responsive" style="max-height: 500px;"><table class="table table-sm table-hover mb-0 align-middle"><tbody id="allUsersTable"></tbody></table></div></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><img id="editUserImg" src="" class="profile-thumb-lg mb-3"><input type="hidden" id="editUserId"><div class="text-start"><div class="mb-3"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="editUserName" class="form-control"></div><div class="mb-3"><label>‡πÅ‡∏ú‡∏ô‡∏Å</label><select id="editUserDept" class="form-select"><option value="General">General</option><option value="Pharmacy">Pharmacy</option><option value="IT">IT Support</option><option value="Admin">Admin</option><option value="Sales">Sales</option></select></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-primary" onclick="saveEditUser()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, updateDoc, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- üî¥ CONFIGURATION ZONE ---
         const firebaseConfig = {

    apiKey: "AIzaSyDEe7ndwzIXokG50MbNykyMG2Ed2bYWvEI",

    authDomain: "in-out-dashboard.firebaseapp.com",

    projectId: "in-out-dashboard",

    storageBucket: "in-out-dashboard.firebasestorage.app",

    messagingSenderId: "846266395224",

    appId: "1:846266395224:web:44d1dfe11692f33ca5f82d",

    measurementId: "G-WN14VJSG17"

  };
        const ADMIN_EMAIL = "medlifeplus@gmail.com"; 
        // -----------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let calendarObj = null;
        let editModal = null;
        let userProfileMap = {};

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboardPage').classList.remove('hidden');
                document.getElementById('adminEmailDisplay').innerText = user.email;
                await cacheUserProfiles(); loadInitialData();
                editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            } else {
                if (isSignInWithEmailLink(auth, window.location.href)) {
                    let e = localStorage.getItem('emailForSignIn') || prompt('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•:');
                    signInWithEmailLink(auth, e, window.location.href).then(() => { localStorage.removeItem('emailForSignIn'); history.replaceState({},'',location.pathname); });
                } else document.getElementById('loginPage').classList.remove('hidden');
            }
        });

        // CACHE IMAGES
        async function cacheUserProfiles() {
            try {
                const snap = await getDocs(collection(db, "users"));
                snap.forEach(doc => { const d=doc.data(); userProfileMap[d.lineUserId] = d.pictureUrl || "https://via.placeholder.com/40"; });
            } catch (e) { console.error(e); }
        }
        function getProfileImg(uid) { return `<img src="${userProfileMap[uid]||'https://via.placeholder.com/40'}" class="profile-thumb">`; }

        // LOADERS
        function loadInitialData() { document.getElementById('filterDate').valueAsDate = new Date(); loadData(); loadUsersList(); loadPendingUsers(); }
        window.switchTab = (tab) => {
            document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); event.target.classList.add('active');
            ['tabAttendance','tabSchedule','tabLeave','tabCalendar','tabUsers'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.remove('hidden');
            if(tab==='schedule') loadSchedules();
            if(tab==='leave') loadLeaveRequests();
            if(tab==='calendar') setTimeout(initCalendar, 200);
            if(tab==='users') { loadPendingUsers(); loadAllUsers(); }
        };

        // ATTENDANCE (with GPS)
        window.loadData = async () => {
            const d = document.getElementById('filterDate').value;
            const s=new Date(d); s.setHours(0,0,0,0); const e=new Date(d); e.setHours(23,59,59,999);
            const snap = await getDocs(query(collection(db,"attendance"), where("timestamp",">=",s), where("timestamp","<=",e)));
            let h = ""; window.currentData = [];
            
            snap.forEach(doc => {
                const v = doc.data();
                window.currentData.push(v);
                const img = getProfileImg(v.userId);
                // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                let mapBtn = '<span class="text-muted">-</span>';
                if(v.mapUrl) mapBtn = `<a href="${v.mapUrl}" target="_blank" class="btn btn-sm btn-outline-primary">üìç ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>`;

                h += `<tr>
                    <td>${new Date(v.timestamp.seconds*1000).toLocaleTimeString('th-TH')}</td>
                    <td><div class="user-cell">${img} <span>${v.name}</span></div></td>
                    <td>${v.dept}</td>
                    <td><span class="${v.type==='‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'?'text-success':'text-danger'} fw-bold">${v.type}</span></td>
                    <td>${mapBtn}</td>
                </tr>`;
            });
            document.getElementById('tableBody').innerHTML = h || "<tr><td colspan='5'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
        };

        window.exportCSV = () => {
            if(!window.currentData?.length) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            let c = "Time,Name,Dept,Type,MapLink\n" + window.currentData.map(r => 
                `${new Date(r.timestamp.seconds*1000).toLocaleTimeString('th-TH')},${r.name},${r.dept},${r.type},${r.mapUrl||''}`
            ).join("\n");
            const a = document.createElement("a"); a.href="data:text/csv;charset=utf-8,"+encodeURI(c); a.download="report.csv"; a.click();
        };

        // SCHEDULE
        window.loadSchedules=async()=>{const s=await getDocs(query(collection(db,"schedules"),orderBy("date","desc")));let h="";s.forEach(d=>{const v=d.data();const img=getProfileImg(v.userId);h+=`<tr><td>${v.date}</td><td><div class="user-cell">${img} ${v.name}</div></td><td>${v.shiftDetail}</td><td><button onclick="delSched('${d.id}')" class="btn btn-sm btn-danger">‡∏•‡∏ö</button></td></tr>`});document.getElementById('schedTableBody').innerHTML=h};
        window.createSchedule=async(e)=>{e.preventDefault();const u=document.getElementById('userSelect');const uid=u.value;const nm=u.options[u.selectedIndex].text;await setDoc(doc(db,"schedules",`${uid}_${document.getElementById('schedDate').value}`),{userId:uid,name:nm,date:document.getElementById('schedDate').value,shiftDetail:document.getElementById('schedType').value});alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');loadSchedules()};
        window.delSched=async(id)=>{if(confirm('‡∏•‡∏ö?'))await deleteDoc(doc(db,"schedules",id));loadSchedules()};

        // LEAVE
        window.loadLeaveRequests=async()=>{const s=await getDocs(query(collection(db,"leave_requests"),where("status","==","Pending")));let h="";s.forEach(doc=>{const d=doc.data();const img=getProfileImg(d.userId);h+=`<tr><td><div class="user-cell">${img} <div>${d.name}<br><small>${d.dept}</small></div></div></td><td><span class="badge bg-info text-dark">${d.type}</span></td><td>${d.startDate} - ${d.endDate}</td><td>${d.reason}</td><td><button onclick="updLeave('${doc.id}','Approved','${d.userId}','${d.name}','${d.startDate}','${d.endDate}','${d.type}')" class="btn btn-sm btn-success">‚úì</button> <button onclick="updLeave('${doc.id}','Rejected')" class="btn btn-sm btn-danger">X</button></td></tr>`});document.getElementById('leaveTableBody').innerHTML=h||"<tr><td colspan='5'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</td></tr>"};
        window.updLeave=async(id,st,uid,nm,s,e,tp)=>{await setDoc(doc(db,"leave_requests",id),{status:st},{merge:true});if(st==='Approved'){let c=new Date(s),end=new Date(e);while(c<=end){let ds=c.toISOString().split('T')[0];await setDoc(doc(db,"schedules",`${uid}_${ds}`),{userId:uid,name:nm,date:ds,shiftDetail:`üõë ${tp}`});c.setDate(c.getDate()+1)}}loadLeaveRequests()};

        // OTHERS
        window.sendLoginLink=()=>{const e=document.getElementById('email').value;sendSignInLinkToEmail(auth,e,{url:window.location.href,handleCodeInApp:true}).then(()=>{localStorage.setItem('emailForSignIn',e);alert('‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß')})};
        window.logout=()=>signOut(auth);
        window.loadUsersList=async()=>{const s=await getDocs(query(collection(db,"users"),where("status","==","Approved")));let h='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>';s.forEach(d=>h+=`<option value="${d.data().lineUserId}">${d.data().name}</option>`);document.getElementById('userSelect').innerHTML=h};
        function initCalendar(){if(calendarObj){calendarObj.render();return}calendarObj=new FullCalendar.Calendar(document.getElementById('calendar'),{initialView:'dayGridMonth',events:async(i,s)=>{const sp=await getDocs(collection(db,"schedules"));let ev=[];sp.forEach(d=>ev.push({title:d.data().name,start:d.data().date,color:d.data().shiftDetail.includes('‡∏´‡∏¢‡∏∏‡∏î')?'#dc3545':'#0d6efd'}));s(ev)}});calendarObj.render()};
        window.loadPendingUsers=async()=>{const s=await getDocs(query(collection(db,"users"),where("status","==","Pending")));let h="";s.forEach(d=>h+=`<tr><td><div class="user-cell"><img src="${d.data().pictureUrl}" class="profile-thumb"> ${d.data().name}</div></td><td><button onclick="appUser('${d.id}')" class="btn btn-sm btn-success">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></td></tr>`);document.getElementById('pendingUsersTable').innerHTML=h;document.getElementById('userBadge').classList.toggle('hidden',s.empty)};
        window.loadAllUsers=async()=>{const s=await getDocs(query(collection(db,"users"),where("status","==","Approved")));let h="";s.forEach(d=>{const u=d.data();h+=`<tr><td><div class="user-cell"><img src="${u.pictureUrl}" class="profile-thumb"> ${u.name}</div></td><td><span class="badge bg-secondary">${u.dept}</span></td><td><button onclick="openEditUser('${d.id}','${u.name}','${u.dept}','${u.pictureUrl}')" class="btn btn-sm btn-outline-primary">‚úèÔ∏è</button> <button onclick="delUser('${d.id}')" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button></td></tr>`});document.getElementById('allUsersTable').innerHTML=h};
        window.appUser=async(id)=>{await setDoc(doc(db,"users",id),{status:"Approved"},{merge:true});loadPendingUsers();loadAllUsers()};
        window.delUser=async(id)=>{if(confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô?'))await deleteDoc(doc(db,"users",id));loadAllUsers()};
        window.openEditUser=(id,nm,dp,pic)=>{document.getElementById('editUserId').value=id;document.getElementById('editUserName').value=nm;document.getElementById('editUserDept').value=dp;document.getElementById('editUserImg').src=pic;editModal.show()};
        window.saveEditUser=async()=>{try{await updateDoc(doc(db,"users",document.getElementById('editUserId').value),{name:document.getElementById('editUserName').value,dept:document.getElementById('editUserDept').value});alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');editModal.hide();loadAllUsers();cacheUserProfiles();}catch(e){alert(e.message)}};
    </script>
</body>
</html>
