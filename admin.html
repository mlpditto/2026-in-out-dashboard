<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MedLife Plus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container { max-width: 1200px; margin-top: 30px; margin-bottom: 50px; }
        .hidden { display: none !important; }
        .nav-tabs .nav-link { cursor: pointer; color: #495057; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; border-bottom: 3px solid #0d6efd; }
        #calendar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
        .profile-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #dee2e6; }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
        .table-responsive { max-height: 600px; }
    </style>
</head>
<body>

    <div id="loginPage" class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="card p-4 shadow-sm text-center" style="width: 400px;">
            <h3 class="mb-3">üè• Admin Login</h3>
            <p class="text-muted small">‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            <input type="email" id="email" class="form-control mb-3" value="medlifeplus@gmail.com">
            <button onclick="sendLoginLink()" id="btnSend" class="btn btn-primary w-100">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Magic Link)</button>
            <div id="loginMsg" class="mt-3 text-success small"></div>
        </div>
    </div>

    <div id="dashboardPage" class="container hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-0">Admin Dashboard</h3>
                <span class="badge bg-secondary" id="adminEmailDisplay">...</span>
            </div>
            <button onclick="logout()" class="btn btn-sm btn-outline-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <ul class="nav nav-tabs mb-4">
            <li class="nav-item"><a class="nav-link active" onclick="switchTab('attendance')">üïí ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('schedule')">‚úçÔ∏è ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('leave')">üì© ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('calendar')">üóìÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</a></li>
            <li class="nav-item"><a class="nav-link" onclick="switchTab('users')">üë• ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô <span id="userBadge" class="badge bg-danger hidden">New</span></a></li>
        </ul>

        <div id="tabAttendance">
            <div class="card">
                <div class="card-header bg-white py-3 d-flex gap-2 align-items-center flex-wrap">
                    <strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong>
                    <input type="date" id="filterDate" class="form-control" style="width: auto;">
                    <button onclick="loadData()" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    <button onclick="exportCSV()" class="btn btn-success ms-auto">üì• Export Excel</button>
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light"><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th></tr></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabSchedule" class="hidden">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card p-3">
                        <h5 class="card-title mb-3">‚úçÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡πÉ‡∏´‡∏°‡πà</h5>
                        <form onsubmit="createSchedule(event)">
                            <div class="mb-2">
                                <label class="form-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                <select id="userSelect" class="form-select" required><option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option></select>
                            </div>
                            <div class="mb-2">
                                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="schedDate" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
                                <select id="schedType" class="form-select">
                                    <option value="‡πÄ‡∏ä‡πâ‡∏≤ (08:00 - 17:00)">‚òÄÔ∏è ‡πÄ‡∏ä‡πâ‡∏≤ (08:00 - 17:00)</option>
                                    <option value="‡∏ö‡πà‡∏≤‡∏¢ (13:00 - 22:00)">üå§Ô∏è ‡∏ö‡πà‡∏≤‡∏¢ (13:00 - 22:00)</option>
                                    <option value="‡∏î‡∏∂‡∏Å (22:00 - 07:00)">üåô ‡∏î‡∏∂‡∏Å (22:00 - 07:00)</option>
                                    <option value="‡πÄ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° (OT)">‚ö° ‡πÄ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏° (OT)</option>
                                    <option value="‡∏´‡∏¢‡∏∏‡∏î (Day Off)">üõë ‡∏´‡∏¢‡∏∏‡∏î (Day Off)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
                            <button onclick="loadSchedules()" class="btn btn-sm btn-outline-secondary">Refresh</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                <tbody id="schedTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tabLeave" class="hidden">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Pending)</h5>
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light"><tr><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="leaveTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabCalendar" class="hidden">
            <div id='calendar'></div>
        </div>

        <div id="tabUsers" class="hidden">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Pending)</h5>
                        </div>
                        <div class="card-body p-0 table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                                <tbody id="pendingUsersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">‚úÖ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                            <button onclick="loadAllUsers()" class="btn btn-sm btn-outline-secondary">Refresh</button>
                        </div>
                        <div class="card-body p-0 table-responsive" style="max-height: 500px;">
                            <table class="table table-sm table-hover mb-0 align-middle">
                                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏•‡∏ö</th></tr></thead>
                                <tbody id="allUsersTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, deleteDoc, doc, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- üî¥ CONFIGURATION ZONE (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDEe7ndwzIXokG50MbNykyMG2Ed2bYWvEI",
            authDomain: "in-out-dashboard.firebaseapp.com",
            projectId: "in-out-dashboard",
            storageBucket: "in-out-dashboard.firebasestorage.app",
            messagingSenderId: "846266395224",
            appId: "1:846266395224:web:44d1dfe11692f33ca5f82d",
            measurementId: "G-WN14VJSG17"
        };
        const ADMIN_EMAIL = "medlifeplus@gmail.com"; 
        // ------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let calendarObj = null;

        // --- 1. AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboardPage').classList.remove('hidden');
                document.getElementById('adminEmailDisplay').innerText = user.email;
                loadInitialData();
            } else {
                // Check if returning from email link
                if (isSignInWithEmailLink(auth, window.location.href)) {
                    let email = window.localStorage.getItem('emailForSignIn');
                    if (!email) email = window.prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á:');
                    
                    signInWithEmailLink(auth, email, window.location.href)
                        .then(() => {
                            window.localStorage.removeItem('emailForSignIn');
                            window.history.replaceState({}, document.title, window.location.pathname);
                            // Page will reload or state change will handle dashboard
                        })
                        .catch(err => alert("Link Error: " + err.message));
                } else {
                    document.getElementById('loginPage').classList.remove('hidden');
                }
            }
        });

        window.sendLoginLink = () => {
            const email = document.getElementById('email').value;
            if(email !== ADMIN_EMAIL) return alert("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á");
            
            const btn = document.getElementById('btnSend');
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

            sendSignInLinkToEmail(auth, email, { url: window.location.href, handleCodeInApp: true })
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);
                    document.getElementById('loginMsg').innerText = "‚úÖ ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Inbox ‡∏´‡∏£‡∏∑‡∏≠ Junk Mail";
                    btn.innerText = "‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";
                })
                .catch(err => {
                    alert(err.message);
                    btn.disabled = false; btn.innerText = "‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•";
                });
        };

        window.logout = () => signOut(auth);

        // --- 2. GLOBAL LOADERS & TABS ---
        function loadInitialData() {
            document.getElementById('filterDate').valueAsDate = new Date();
            loadData();         // Attendance
            loadUsersList();    // User Dropdown
            loadPendingUsers(); // User Management
        }

        window.switchTab = (tabName) => {
            // UI Toggle
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            ['tabAttendance', 'tabSchedule', 'tabLeave', 'tabCalendar', 'tabUsers'].forEach(id => document.getElementById(id).classList.add('hidden'));

            // Logic Load
            if (tabName === 'attendance') document.getElementById('tabAttendance').classList.remove('hidden');
            if (tabName === 'schedule') { 
                document.getElementById('tabSchedule').classList.remove('hidden'); 
                loadSchedules(); 
            }
            if (tabName === 'leave') { 
                document.getElementById('tabLeave').classList.remove('hidden'); 
                loadLeaveRequests(); 
            }
            if (tabName === 'calendar') { 
                document.getElementById('tabCalendar').classList.remove('hidden'); 
                setTimeout(initCalendar, 200); // Delay for render
            }
            if (tabName === 'users') { 
                document.getElementById('tabUsers').classList.remove('hidden'); 
                loadPendingUsers(); 
                loadAllUsers(); 
            }
        };

        // --- 3. ATTENDANCE ---
        window.loadData = async () => {
            const dateVal = document.getElementById('filterDate').value;
            const start = new Date(dateVal); start.setHours(0,0,0,0);
            const end = new Date(dateVal); end.setHours(23,59,59,999);
            const tbody = document.getElementById('tableBody');
            
            tbody.innerHTML = "<tr><td colspan='5' class='text-center'>Loading...</td></tr>";

            try {
                const q = query(collection(db, "attendance"), where("timestamp", ">=", start), where("timestamp", "<=", end));
                const snap = await getDocs(q);
                let html = "";
                window.currentData = [];

                snap.forEach(doc => {
                    const d = doc.data();
                    window.currentData.push(d);
                    const time = new Date(d.timestamp.seconds*1000).toLocaleTimeString('th-TH');
                    const color = d.type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'text-success' : 'text-danger';
                    html += `<tr><td>${time}</td><td>${d.name}</td><td>${d.dept||'-'}</td><td class="${color} fw-bold">${d.type}</td><td>Mobile/PC</td></tr>`;
                });
                
                // Sort by time
                window.currentData.sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                tbody.innerHTML = html || "<tr><td colspan='5' class='text-center text-muted'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan='5' class='text-danger'>Error: ${err.message} (Check Console for Index)</td></tr>`;
            }
        };

        window.exportCSV = () => {
            if(!window.currentData || window.currentData.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export");
            let csv = "Time,Name,Department,Type\n";
            window.currentData.forEach(r => {
                csv += `${new Date(r.timestamp.seconds*1000).toLocaleTimeString('th-TH')},${r.name},${r.dept||''},${r.type}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = `attendance_${document.getElementById('filterDate').value}.csv`;
            link.click();
        };

        // --- 4. SCHEDULE ---
        window.loadUsersList = async () => {
            const q = query(collection(db, "users"), where("status", "==", "Approved"));
            const snap = await getDocs(q);
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';
            snap.forEach(doc => {
                const u = doc.data();
                select.innerHTML += `<option value="${u.lineUserId}" data-name="${u.name}">${u.name}</option>`;
            });
        };

        window.createSchedule = async (e) => {
            e.preventDefault();
            const uid = document.getElementById('userSelect').value;
            const name = document.getElementById('userSelect').selectedOptions[0].dataset.name;
            const date = document.getElementById('schedDate').value;
            const detail = document.getElementById('schedType').value;

            await setDoc(doc(db, "schedules", `${uid}_${date}`), {
                userId: uid, name: name, date: date, shiftDetail: detail
            });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); loadSchedules();
        };

        window.loadSchedules = async () => {
            const tbody = document.getElementById('schedTableBody');
            const q = query(collection(db, "schedules"), orderBy("date", "desc"));
            const snap = await getDocs(q);
            let html = "";
            snap.forEach(doc => {
                const s = doc.data();
                html += `<tr><td>${s.date}</td><td>${s.name}</td><td>${s.shiftDetail}</td><td><button onclick="delSched('${doc.id}')" class="btn btn-sm btn-danger">‡∏•‡∏ö</button></td></tr>`;
            });
            tbody.innerHTML = html || "<tr><td colspan='4' class='text-center'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>";
        };

        window.delSched = async(id) => { if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?")) { await deleteDoc(doc(db,"schedules",id)); loadSchedules(); } };

        // --- 5. LEAVE REQUESTS ---
        window.loadLeaveRequests = async () => {
            const tbody = document.getElementById('leaveTableBody');
            const q = query(collection(db, "leave_requests"), where("status", "==", "Pending"));
            const snap = await getDocs(q);
            let html = "";
            snap.forEach(doc => {
                const d = doc.data();
                html += `<tr><td>${d.name}<br><small>${d.dept}</small></td><td><span class="badge bg-info text-dark">${d.type}</span></td><td>${d.startDate} ‡∏ñ‡∏∂‡∏á ${d.endDate}</td><td>${d.reason||'-'}</td>
                <td><button onclick="updLeave('${doc.id}','Approved','${d.userId}','${d.name}','${d.startDate}','${d.endDate}','${d.type}')" class="btn btn-sm btn-success">‚úÖ</button> 
                <button onclick="updLeave('${doc.id}','Rejected')" class="btn btn-sm btn-danger">‚ùå</button></td></tr>`;
            });
            tbody.innerHTML = html || "<tr><td colspan='5' class='text-center text-muted'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</td></tr>";
        };

        window.updLeave = async (id, status, uid, name, start, end, type) => {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${status}?`)) return;
            await setDoc(doc(db, "leave_requests", id), { status: status }, { merge: true });
            
            // If approved, create schedules automatically
            if (status === 'Approved') {
                let curr = new Date(start); const last = new Date(end);
                while (curr <= last) {
                    const ds = curr.toISOString().split('T')[0];
                    await setDoc(doc(db, "schedules", `${uid}_${ds}`), {
                        userId: uid, name: name, date: ds, shiftDetail: `üõë ${type} (‡∏•‡∏≤)`
                    });
                    curr.setDate(curr.getDate() + 1);
                }
            }
            loadLeaveRequests();
        };

        // --- 6. CALENDAR ---
        function initCalendar() {
            if (calendarObj) { calendarObj.render(); return; }
            calendarObj = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                locale: 'th',
                height: 'auto',
                events: async (info, successCallback, failureCallback) => {
                    const snap = await getDocs(collection(db, "schedules"));
                    let events = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        let color = '#0d6efd'; // Blue
                        if (d.shiftDetail.includes('‡∏ö‡πà‡∏≤‡∏¢')) color = '#fd7e14'; // Orange
                        if (d.shiftDetail.includes('‡∏î‡∏∂‡∏Å')) color = '#6610f2'; // Purple
                        if (d.shiftDetail.includes('‡∏´‡∏¢‡∏∏‡∏î') || d.shiftDetail.includes('‡∏•‡∏≤')) color = '#dc3545'; // Red
                        
                        events.push({
                            title: `${d.name} (${d.shiftDetail.split('(')[0]})`,
                            start: d.date,
                            color: color
                        });
                    });
                    successCallback(events);
                }
            });
            calendarObj.render();
        }

        // --- 7. USERS MANAGEMENT ---
        window.loadPendingUsers = async () => {
            const tbody = document.getElementById('pendingUsersTable');
            const q = query(collection(db, "users"), where("status", "==", "Pending"));
            const snap = await getDocs(q);
            
            document.getElementById('userBadge').classList.toggle('hidden', snap.empty);
            
            let html = "";
            snap.forEach(doc => {
                const u = doc.data();
                html += `<tr><td><img src="${u.pictureUrl}" class="profile-thumb"></td>
                <td><strong>${u.name}</strong><br><small class="text-muted">ID: ${u.empId} | ${u.dept}</small></td>
                <td><button onclick="appUser('${doc.id}')" class="btn btn-sm btn-success">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></td></tr>`;
            });
            tbody.innerHTML = html || "<tr><td colspan='3' class='text-center text-muted'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td></tr>";
        };

        window.loadAllUsers = async () => {
            const tbody = document.getElementById('allUsersTable');
            const q = query(collection(db, "users"), where("status", "==", "Approved"));
            const snap = await getDocs(q);
            let html = "";
            snap.forEach(doc => {
                const u = doc.data();
                html += `<tr><td>${u.name}</td><td>${u.dept}</td><td><button onclick="delUser('${doc.id}')" class="btn btn-sm btn-outline-danger">‡∏•‡∏ö</button></td></tr>`;
            });
            tbody.innerHTML = html;
        };

        window.appUser = async (id) => {
            if(confirm("‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô?")) {
                await setDoc(doc(db,"users",id), {status: "Approved"}, {merge: true});
                loadPendingUsers(); loadAllUsers();
            }
        };

        window.delUser = async (id) => {
            if(confirm("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) {
                await deleteDoc(doc(db,"users",id));
                loadAllUsers();
            }
        };

        // Export functions to global scope
        window.loadData = loadData; window.exportCSV = exportCSV;
        window.loadUsersList = loadUsersList; window.createSchedule = createSchedule; window.loadSchedules = loadSchedules; window.delSched = delSched;
        window.loadLeaveRequests = loadLeaveRequests; window.updLeave = updLeave;
        window.loadPendingUsers = loadPendingUsers; window.loadAllUsers = loadAllUsers; window.appUser = appUser; window.delUser = delUser;

    </script>
</body>
</html>
