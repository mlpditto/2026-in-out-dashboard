<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MedLife Plus</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --color-in: #198754; --color-out: #dc3545; --color-leave: #6c757d;
            --bg-body: #f4f6f9; --color-primary: #0d6efd;
            --color-shift-am: #0d6efd; --color-shift-pm: #fd7e14; --color-shift-night: #6f42c1;
        }

        body { background-color: var(--bg-body); font-family: 'Sarabun', sans-serif; font-size: 0.95rem; }

        /* VISIBILITY */
        .hidden { display: none !important; }
        .tab-section { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Table Styles */
        .table-responsive { max-height: 70vh; overflow-y: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        thead th { position: sticky; top: 0; background-color: #f8f9fa !important; z-index: 10; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
        .table-hover tbody tr:hover { background-color: rgba(13, 110, 253, 0.05); transition: 0.2s; }
        
        /* Components */
        .col-user { width: 250px; min-width: 250px; }
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .profile-thumb { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .mono-font { font-family: 'Roboto Mono', monospace; font-weight: 500; }
        .badge-pill { border-radius: 50px; padding: 0.4em 0.8em; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        /* Nav Tabs */
        .nav-tabs { border-bottom: 2px solid #e9ecef; margin-bottom: 20px; flex-wrap: nowrap; overflow-x: auto; }
        .nav-tabs .nav-link { border: none; color: #6c757d; font-weight: 600; padding: 1rem 1.5rem; transition: 0.2s; cursor: pointer; white-space: nowrap; }
        .nav-tabs .nav-link:hover { color: var(--color-primary); background: rgba(13, 110, 253, 0.05); }
        .nav-tabs .nav-link.active { color: var(--color-primary); border-bottom: 3px solid var(--color-primary); background: transparent; }

        /* Login Card */
        .login-card { border: none; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); background: white; padding: 3rem; width: 100%; max-width: 420px; }
        .btn-google { background-color: #fff; border: 1px solid #ddd; color: #333; font-weight: 600; }
        .btn-google:hover { background-color: #f8f9fa; }
        .btn-google img { width: 20px; margin-right: 10px; }
    </style>
</head>
<body>

    <div id="loginPage" class="d-flex justify-content-center align-items-center" style="height: 100vh; background: #eef2f6;">
        <div class="login-card text-center">
            <div class="mb-4">
                <i class="bi bi-hospital-fill text-primary" style="font-size: 4rem;"></i>
                <h3 class="mt-3 fw-bold text-dark">MedLife Plus</h3>
                <p class="text-muted">Admin Portal</p>
            </div>
            <div class="alert alert-info small text-start"><i class="bi bi-info-circle me-1"></i> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ <b>medlifeplus@gmail.com</b></div>
            <button onclick="loginWithGoogle()" class="btn btn-google btn-lg w-100 py-3 mb-3 shadow-sm d-flex align-items-center justify-content-center">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
        </div>
    </div>

    <div id="dashboardPage" class="hidden">
        <nav class="navbar navbar-light bg-white border-bottom px-4 py-3 sticky-top">
            <div class="d-flex align-items-center gap-3"><i class="bi bi-hospital-fill text-primary fs-3"></i><h5 class="mb-0 fw-bold d-none d-md-block">MedLife Plus <span class="text-muted fw-normal fs-6">| Admin</span></h5></div>
            <div class="dropdown">
                <button class="btn btn-light rounded-pill border d-flex align-items-center gap-2 px-3" data-bs-toggle="dropdown">
                    <img id="adminProfilePic" src="https://via.placeholder.com/30" class="rounded-circle" style="width: 30px; height: 30px;">
                    <span class="d-none d-sm-block small fw-bold" id="adminEmailDisplay">Admin</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0"><li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a></li></ul>
            </div>
        </nav>

        <div class="container-fluid px-4 py-4">
            <div class="row g-3 mb-4">
                <div class="col-md-3 col-6"><div class="card p-3 border-start border-4 border-success shadow-sm"><small class="text-muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small><h3 class="fw-bold my-1 text-success" id="statIn">0</h3></div></div>
                <div class="col-md-3 col-6"><div class="card p-3 border-start border-4 border-warning shadow-sm"><small class="text-muted">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏≤</small><h3 class="fw-bold my-1 text-warning" id="statLeave">0</h3></div></div>
                <div class="col-md-3 col-6"><div class="card p-3 border-start border-4 border-info shadow-sm"><small class="text-muted">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small><h3 class="fw-bold my-1 text-info" id="statTotalUsers">0</h3></div></div>
                <div class="col-md-3 col-6"><div class="card p-3 border-start border-4 border-danger shadow-sm"><small class="text-muted">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</small><h3 class="fw-bold my-1 text-danger" id="statNewUsers">0</h3></div></div>
            </div>

            <ul class="nav nav-tabs" id="mainTab" role="tablist">
                <li class="nav-item"><a class="nav-link active" onclick="switchTab('attendance')"><i class="bi bi-clock me-2"></i>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</a></li>
                <li class="nav-item"><a class="nav-link" onclick="switchTab('schedule')"><i class="bi bi-calendar-check me-2"></i>‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£</a></li>
                <li class="nav-item"><a class="nav-link" onclick="switchTab('leave')"><i class="bi bi-send me-2"></i>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</a></li>
                <li class="nav-item"><a class="nav-link" onclick="switchTab('report')"><i class="bi bi-graph-up me-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô & ‡∏Å‡∏£‡∏≤‡∏ü</a></li>
                <li class="nav-item"><a class="nav-link" onclick="switchTab('users')"><i class="bi bi-person-gear me-2"></i>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</a></li>
            </ul>

            <div id="tabAttendance" class="tab-section">
                <div class="card shadow-sm border-0"><div class="card-body">
                    <div class="d-flex gap-2 mb-3"><input type="date" id="filterDate" class="form-control" style="width: auto;"><button onclick="loadData()" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button><button onclick="exportCSV()" class="btn btn-outline-success ms-auto">Export</button></div>
                    <div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th class="ps-3">‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th></tr></thead><tbody id="tableBody"></tbody></table></div>
                </div></div>
            </div>

            <div id="tabSchedule" class="tab-section hidden">
                <div class="row g-4"><div class="col-lg-4"><div class="card shadow-sm border-0 h-100"><div class="card-header bg-white fw-bold py-3">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div><div class="card-body"><form onsubmit="createSchedule(event)"><div class="mb-3"><label class="small text-muted">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><select id="userSelect" class="form-select" required></select></div><div class="mb-3"><label class="small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="schedDate" class="form-control" required></div><div class="mb-4"><label class="small text-muted">‡∏Å‡∏∞</label><select id="schedType" class="form-select"><option>‡πÄ‡∏ä‡πâ‡∏≤ (08:00 - 17:00)</option><option>‡∏ö‡πà‡∏≤‡∏¢ (13:00 - 22:00)</option><option>‡∏î‡∏∂‡∏Å (22:00 - 07:00)</option><option>‡∏´‡∏¢‡∏∏‡∏î (Day Off)</option></select></div><button type="submit" class="btn btn-primary w-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form></div></div></div><div class="col-lg-8"><div class="card shadow-sm border-0 h-100"><div class="card-header bg-white d-flex justify-content-between py-3"><span class="fw-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span><button onclick="loadSchedules()" class="btn btn-sm btn-light border"><i class="bi bi-arrow-clockwise"></i></button></div><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏Å‡∏∞</th><th>‡∏•‡∏ö</th></tr></thead><tbody id="schedTableBody"></tbody></table></div></div></div></div>
            </div>

            <div id="tabLeave" class="tab-section hidden">
                <div class="card shadow-sm border-0 border-start border-4 border-warning"><div class="card-header bg-white py-3 fw-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th class="ps-3">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th class="text-end pe-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="leaveTableBody"></tbody></table></div></div>
            </div>

            <div id="tabReport" class="tab-section hidden">
                <div class="card shadow-sm border-0 mb-4"><div class="card-body"><h5 class="fw-bold mb-3">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</h5><div id='calendar'></div></div></div>
                <div class="card shadow-sm border-0"><div class="card-header bg-white fw-bold py-3">‡∏Å‡∏£‡∏≤‡∏ü‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div><div class="card-body"><div class="d-flex gap-2 mb-3"><input type="month" id="chartMonth" class="form-control" style="width: 200px;"><button onclick="renderCharts()" class="btn btn-dark">‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü</button></div><canvas id="workHoursChart" style="max-height: 300px;"></canvas></div></div>
            </div>

            <div id="tabUsers" class="tab-section hidden">
                <div class="row g-4"><div class="col-lg-5"><div class="card shadow-sm border-0 border-start border-4 border-danger"><div class="card-header bg-white text-danger fw-bold py-3">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Pending)</div><div class="table-responsive"><table class="table table-hover align-middle mb-0"><tbody id="pendingUsersTable"></tbody></table></div></div></div><div class="col-lg-7"><div class="card shadow-sm border-0 border-start border-4 border-primary"><div class="card-header bg-white text-primary fw-bold py-3 d-flex justify-content-between"><span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><button onclick="loadAllUsers()" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-clockwise"></i></button></div><div class="table-responsive" style="max-height: 500px;"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th class="ps-3">‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="text-end pe-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="allUsersTable"></tbody></table></div></div></div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editUserModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header border-0 bg-light"><h5 class="modal-title fw-bold">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center p-4"><img id="editUserImg" src="" class="profile-thumb shadow-sm mb-3" style="width:80px; height:80px;"><input type="hidden" id="editUserId"><div class="form-floating mb-3 text-start"><input type="text" id="editUserName" class="form-control"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label></div><div class="form-floating text-start"><select id="editUserDept" class="form-select"><option value="General">General</option><option value="Pharmacy">Pharmacy</option><option value="IT">IT Support</option><option value="Admin">Admin</option><option value="Sales">Sales</option></select><label>‡πÅ‡∏ú‡∏ô‡∏Å</label></div></div><div class="modal-footer border-0 bg-light"><button type="button" class="btn btn-light" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="button" class="btn btn-primary px-4" onclick="saveEditUser()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, updateDoc, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- üî¥ CONFIG ---
         const firebaseConfig = {

    apiKey: "AIzaSyDEe7ndwzIXokG50MbNykyMG2Ed2bYWvEI",

    authDomain: "in-out-dashboard.firebaseapp.com",

    projectId: "in-out-dashboard",

    storageBucket: "in-out-dashboard.firebasestorage.app",

    messagingSenderId: "846266395224",

    appId: "1:846266395224:web:44d1dfe11692f33ca5f82d",

    measurementId: "G-WN14VJSG17"

  };
        const ADMIN_EMAIL = "medlifeplus@gmail.com"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let calendarObj, editModal, barChart;
        let userProfileMap = {};
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboardPage').classList.remove('hidden');
                    document.getElementById('adminEmailDisplay').innerText = user.displayName || user.email;
                    document.getElementById('adminProfilePic').src = user.photoURL || "https://via.placeholder.com/30";
                    await cacheUserProfiles(); loadInitialData();
                    editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    document.getElementById('chartMonth').value = new Date().toISOString().slice(0, 7);
                } else { await signOut(auth); Swal.fire('Access Denied', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', 'error'); }
            } else {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('dashboardPage').classList.add('hidden');
            }
        });

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { Swal.fire('Login Error', e.message, 'error'); } };

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tabName === 'schedule') loadSchedules();
            if(tabName === 'leave') loadLeaveRequests();
            if(tabName === 'report') { setTimeout(initCalendar, 200); renderCharts(); }
            if(tabName === 'users') { loadPendingUsers(); loadAllUsers(); }
        };

        window.loadData=async()=>{const d=document.getElementById('filterDate').value;const s=new Date(d);s.setHours(0,0,0,0);const e=new Date(d);e.setHours(23,59,59,999);const t=document.getElementById('tableBody');t.innerHTML='<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';const q=query(collection(db,"attendance"),where("timestamp",">=",s),where("timestamp","<=",e));const snap=await getDocs(q);let h="",c=0;window.currentData=[];snap.forEach(doc=>{const v=doc.data();window.currentData.push(v);if(v.type==='‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')c++;const bg=v.type==='‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô'?'bg-success':'bg-danger';const map=v.mapUrl?`<a href="${v.mapUrl}" target="_blank" class="btn btn-sm btn-light border text-primary"><i class="bi bi-geo-alt-fill"></i></a>`:'-';h+=`<tr><td class="ps-3 mono-font">${new Date(v.timestamp.seconds*1000).toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'})}</td><td class="col-user"><div class="user-cell">${getProfileImg(v.userId)}<div><h6 class="mb-0">${v.name}</h6><small class="text-muted">${v.empId||''}</small></div></div></td><td><span class="badge bg-light text-dark border">${v.dept}</span></td><td><span class="badge ${bg} bg-opacity-10 text-${bg.split('-')[1]} badge-pill"><span class="status-dot ${bg}"></span>${v.type}</span></td><td>${map}</td></tr>`});t.innerHTML=h||`<tr><td colspan="5" class="text-center py-5 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;document.getElementById('statIn').innerText=c;};

        async function cacheUserProfiles(){const s=await getDocs(collection(db,"users"));document.getElementById('statTotalUsers').innerText=s.size;s.forEach(d=>userProfileMap[d.data().lineUserId]=d.data().pictureUrl);}
        function getProfileImg(uid){return `<img src="${userProfileMap[uid]||'https://via.placeholder.com/45'}" class="profile-thumb">`;}
        function loadInitialData(){document.getElementById('filterDate').valueAsDate=new Date();loadData();loadUsersList();loadPendingUsers();}
        window.loadSchedules=async()=>{const s=await getDocs(query(collection(db,"schedules"),orderBy("date","desc")));let h="";s.forEach(d=>{const v=d.data();const img=getProfileImg(v.userId);h+=`<tr><td>${v.date}</td><td><div class="user-cell">${img} ${v.name}</div></td><td><span class="badge bg-light text-dark border">${v.shiftDetail}</span></td><td><button onclick="delSched('${d.id}')" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button></td></tr>`});document.getElementById('schedTableBody').innerHTML=h};
        window.createSchedule=async(e)=>{e.preventDefault();const u=document.getElementById('userSelect');await setDoc(doc(db,"schedules",`${u.value}_${document.getElementById('schedDate').value}`),{userId:u.value,name:u.options[u.selectedIndex].text,date:document.getElementById('schedDate').value,shiftDetail:document.getElementById('schedType').value});Toast.fire({icon:'success',title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'});loadSchedules()};
        window.delSched=async(id)=>{if((await Swal.fire({title:'‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?',icon:'warning',showCancelButton:true})).isConfirmed){await deleteDoc(doc(db,"schedules",id));loadSchedules();}};
        window.loadLeaveRequests=async()=>{const s=await getDocs(query(collection(db,"leave_requests"),where("status","==","Pending")));let h="";s.forEach(doc=>{const d=doc.data();const img=getProfileImg(d.userId);h+=`<tr><td class="ps-3"><div class="user-cell">${img} <div><h6>${d.name}</h6><small>${d.dept}</small></div></div></td><td><span class="badge bg-warning text-dark">${d.type}</span></td><td>${d.startDate} - ${d.endDate}</td><td>${d.reason}</td><td class="text-end pe-3"><button onclick="updLeave('${doc.id}','Approved','${d.userId}','${d.name}','${d.startDate}','${d.endDate}','${d.type}')" class="btn btn-sm btn-success me-1"><i class="bi bi-check-lg"></i></button><button onclick="updLeave('${doc.id}','Rejected')" class="btn btn-sm btn-danger"><i class="bi bi-x-lg"></i></button></td></tr>`});document.getElementById('leaveTableBody').innerHTML=h||`<tr><td colspan="5" class="text-center py-4 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</td></tr>`; document.getElementById('statLeave').innerText = s.size; };
        window.updLeave=async(id,st,uid,nm,s,e,tp)=>{await setDoc(doc(db,"leave_requests",id),{status:st},{merge:true});if(st==='Approved'){let c=new Date(s),end=new Date(e);while(c<=end){let ds=c.toISOString().split('T')[0];await setDoc(doc(db,"schedules",`${uid}_${ds}`),{userId:uid,name:nm,date:ds,shiftDetail:`üõë ${tp}`});c.setDate(c.getDate()+1)}}Toast.fire({icon:'success',title:'‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'});loadLeaveRequests();};
        window.renderCharts=async()=>{const m=document.getElementById('chartMonth').value; if(!m)return; const start=new Date(m+"-01"); start.setHours(0,0,0,0); const end=new Date(m+"-01"); end.setMonth(end.getMonth()+1); end.setDate(0); end.setHours(23,59,59,999); const snap=await getDocs(query(collection(db,"attendance"),where("timestamp",">=",start),where("timestamp","<=",end))); let uH={}; snap.forEach(d=>{const v=d.data(); if(!uH[v.name])uH[v.name]={logs:[]}; uH[v.name].logs.push({t:v.type,time:v.timestamp.seconds})}); let lbs=[],dts=[]; Object.keys(uH).forEach(n=>{const l=uH[n].logs.sort((a,b)=>a.time-b.time); let ms=0,last=null; l.forEach(x=>{if(x.t==='‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')last=x.time;else if(x.t==='‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'&&last){ms+=(x.time-last);last=null}}); if(ms>0){lbs.push(n);dts.push((ms/3600).toFixed(1))}}); if(barChart)barChart.destroy(); barChart=new Chart(document.getElementById('workHoursChart'),{type:'bar',data:{labels:lbs,datasets:[{label:'‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',data:dts,backgroundColor:'#0d6efd'}]},options:{responsive:true}});};
        function initCalendar(){if(calendarObj){calendarObj.render();return}calendarObj=new FullCalendar.Calendar(document.getElementById('calendar'),{initialView:'dayGridMonth',locale:'th',height:'auto',events:async(info,s,f)=>{try{let ev=[]; const sn=await getDocs(collection(db,"schedules")); sn.forEach(d=>{const v=d.data(); let c='var(--color-shift-am)'; if(v.shiftDetail.includes('‡∏ö‡πà‡∏≤‡∏¢'))c='var(--color-shift-pm)'; if(v.shiftDetail.includes('‡∏î‡∏∂‡∏Å'))c='var(--color-shift-night)'; if(v.shiftDetail.includes('‡∏´‡∏¢‡∏∏‡∏î')||v.shiftDetail.includes('‡∏•‡∏≤'))c='var(--color-leave)'; ev.push({title:`${v.name}`,start:v.date,color:c})}); s(ev);}catch(e){f(e)}}}); calendarObj.render();}
        window.loadPendingUsers=async()=>{const s=await getDocs(query(collection(db,"users"),where("status","==","Pending")));let h="";s.forEach(d=>{const v=d.data();h+=`<tr><td class="ps-3"><div class="user-cell"><img src="${v.pictureUrl}" class="profile-thumb"> <div><h6>${v.name}</h6><small class="text-danger">New Register</small></div></div></td><td class="text-end pe-3"><button onclick="appUser('${d.id}')" class="btn btn-sm btn-success px-3">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button></td></tr>`});document.getElementById('pendingUsersTable').innerHTML=h||`<tr><td colspan="2" class="text-center py-3 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</td></tr>`; document.getElementById('statNewUsers').innerText=s.size;};
        window.loadAllUsers=async()=>{const s=await getDocs(query(collection(db,"users"),where("status","==","Approved")));let h="";s.forEach(d=>{const u=d.data();h+=`<tr><td class="ps-3"><div class="user-cell"><img src="${u.pictureUrl}" class="profile-thumb"><h6>${u.name}</h6></div></td><td><span class="badge bg-light text-dark border">${u.dept}</span></td><td class="text-end pe-3"><button onclick="openEditUser('${d.id}','${u.name}','${u.dept}','${u.pictureUrl}')" class="btn btn-sm btn-light border me-1"><i class="bi bi-pencil"></i></button><button onclick="delUser('${d.id}')" class="btn btn-sm btn-light border text-danger"><i class="bi bi-trash"></i></button></td></tr>`});document.getElementById('allUsersTable').innerHTML=h};
        window.appUser=async(id)=>{await setDoc(doc(db,"users",id),{status:"Approved"},{merge:true});Toast.fire({icon:'success',title:'‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß'});loadPendingUsers();loadAllUsers();};
        window.delUser=async(id)=>{if((await Swal.fire({title:'‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô?',icon:'warning',showCancelButton:true})).isConfirmed){await deleteDoc(doc(db,"users",id));loadAllUsers();Toast.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success')}};
        window.openEditUser=(id,nm,dp,pic)=>{document.getElementById('editUserId').value=id;document.getElementById('editUserName').value=nm;document.getElementById('editUserDept').value=dp;document.getElementById('editUserImg').src=pic;editModal.show()};
        window.saveEditUser=async()=>{try{await updateDoc(doc(db,"users",document.getElementById('editUserId').value),{name:document.getElementById('editUserName').value,dept:document.getElementById('editUserDept').value});Toast.fire({icon:'success',title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'});editModal.hide();loadAllUsers();cacheUserProfiles();}catch(e){Swal.fire('Error',e.message,'error')}};
        window.logout=()=>signOut(auth);
        window.loadUsersList=async()=>{const s=await getDocs(query(collection(db,"users"),where("status","==","Approved")));let h='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</option>';s.forEach(d=>h+=`<option value="${d.data().lineUserId}">${d.data().name}</option>`);document.getElementById('userSelect').innerHTML=h};
        window.exportCSV=()=>{if(!window.currentData?.length)return Toast.fire({icon:'warning',title:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'});let c="Time,Name,Dept,Type,MapLink\n"+window.currentData.map(r=>`${new Date(r.timestamp.seconds*1000).toLocaleTimeString('th-TH')},${r.name},${r.dept},${r.type},${r.mapUrl||''}`).join("\n");const a=document.createElement("a");a.href="data:text/csv;charset=utf-8,"+encodeURI(c);a.download=`attendance_${new Date().toISOString().split('T')[0]}.csv`;a.click()};

        // GLOBAL SCOPE
        window.loginWithGoogle=loginWithGoogle; window.logout=logout; window.loadData=loadData; window.exportCSV=exportCSV; window.switchTab=switchTab; window.loadSchedules=loadSchedules; window.createSchedule=createSchedule; window.delSched=delSched; window.loadLeaveRequests=loadLeaveRequests; window.updLeave=updLeave; window.renderCharts=renderCharts; window.loadPendingUsers=loadPendingUsers; window.loadAllUsers=loadAllUsers; window.appUser=appUser; window.delUser=delUser; window.openEditUser=openEditUser; window.saveEditUser=saveEditUser;
    </script>
</body>
</html>
