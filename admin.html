<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; margin-top: 30px; }
        .hidden { display: none !important; }
        .profile-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .status-in { color: #198754; font-weight: bold; }
        .status-out { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginPage" class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="card p-4 shadow" style="width: 400px; text-align: center;">
            <h3 class="mb-3">Admin Login</h3>
            <p class="text-muted small">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</p>
            
            <div class="mb-3 text-start">
                <label>Email</label>
                <input type="email" id="email" class="form-control" value="medlifeplus@gmail.com" readonly>
            </div>
            
            <button onclick="sendLoginLink()" id="btnSend" class="btn btn-primary w-100">
                ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏• (Magic Link)
            </button>
            <div id="loginMsg" class="mt-3 text-success small"></div>
        </div>
    </div>

    <div id="dashboardPage" class="container hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>üìÖ Admin Dashboard</h2>
                <span class="badge bg-info text-dark" id="adminEmailDisplay">...</span>
            </div>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="filterDate" class="form-control" style="width: auto;">
                    <button onclick="loadData()" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
                <button onclick="exportCSV()" class="btn btn-success mt-2 mt-md-0">üì• Export Excel</button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>‡∏£‡∏π‡∏õ</th>
                                <th>‡∏£‡∏´‡∏±‡∏™</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div id="noData" class="p-4 text-center text-muted hidden">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ZONE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDEe7ndwzIXokG50MbNykyMG2Ed2bYWvEI",
            authDomain: "in-out-dashboard.firebaseapp.com",
            projectId: "in-out-dashboard",
            storageBucket: "in-out-dashboard.firebasestorage.app",
            messagingSenderId: "846266395224",
            appId: "1:846266395224:web:44d1dfe11692f33ca5f82d",
            measurementId: "G-WN14VJSG17"
        };
        const ADMIN_EMAIL = "medlifeplus@gmail.com"; // ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        // -------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.getElementById('filterDate').valueAsDate = new Date();

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ User ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏• Admin ‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
                if(user.email !== ADMIN_EMAIL) {
                    alert("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Access Denied)");
                    signOut(auth);
                    return;
                }
                showDashboard(user);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏™ "‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                checkIfComingFromEmailLink();
            }
        });

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå (Magic Link)
        window.sendLoginLink = () => {
            const email = document.getElementById('email').value;
            
            if (email !== ADMIN_EMAIL) {
                return alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            }

            const actionCodeSettings = {
                url: window.location.href, // ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                handleCodeInApp: true
            };

            const btn = document.getElementById('btnSend');
            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";

            sendSignInLinkToEmail(auth, email, actionCodeSettings)
                .then(() => {
                    window.localStorage.setItem('emailForSignIn', email);
                    document.getElementById('loginMsg').innerText = `‚úÖ ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${email} ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ Inbox ‡∏´‡∏£‡∏∑‡∏≠ Junk Mail`;
                    btn.innerText = "‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                })
                .catch((error) => {
                    console.error(error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
                    btn.disabled = false;
                    btn.innerText = "‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•";
                });
        };

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        function checkIfComingFromEmailLink() {
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    email = window.prompt('‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á:');
                }
                
                signInWithEmailLink(auth, email, window.location.href)
                    .then((result) => {
                        window.localStorage.removeItem('emailForSignIn');
                        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå URL ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏á
                        window.history.replaceState({}, document.title, window.location.pathname);
                        // onAuthStateChanged ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    })
                    .catch((error) => {
                        alert("‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏Ç‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡∏°‡πà");
                        console.error(error);
                    });
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô -> ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('dashboardPage').classList.add('hidden');
            }
        }

        // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Dashboard
        function showDashboard(user) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            document.getElementById('adminEmailDisplay').innerText = user.email;
            loadData();
        }

        window.logout = () => signOut(auth);

        // 5. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        window.loadData = async () => {
            const dateVal = document.getElementById('filterDate').value;
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
            document.getElementById('noData').classList.add('hidden');

            const start = new Date(dateVal); start.setHours(0,0,0,0);
            const end = new Date(dateVal); end.setHours(23,59,59,999);

            try {
                const q = query(
                    collection(db, "attendance"),
                    where("timestamp", ">=", start),
                    where("timestamp", "<=", end)
                );
                const querySnapshot = await getDocs(q);
                let html = "";
                let rawData = [];

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    rawData.push(data);
                });
                rawData.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                if(rawData.length === 0) {
                    tbody.innerHTML = "";
                    document.getElementById('noData').classList.remove('hidden');
                    return;
                }

                rawData.forEach(item => {
                    const time = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleTimeString('th-TH') : "-";
                    const statusClass = item.type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'status-in' : 'status-out';
                    
                    html += `
                        <tr>
                            <td>${time}</td>
                            <td>${item.lineUserId ? `<img src="${item.pictureUrl}" class="profile-thumb">` : '-'}</td>
                            <td>${item.empId || '-'}</td>
                            <td>${item.name}</td>
                            <td>${item.dept || '-'}</td>
                            <td class="${statusClass}">${item.type}</td>
                            <td class="text-muted small">${item.userAgent.includes("Mobile") ? "Mobile" : "PC"}</td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
                window.currentData = rawData; 

            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">Error: ${err.message}</td></tr>`;
            }
        };

        // 6. Export Excel (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        window.exportCSV = () => {
            if (!window.currentData || window.currentData.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            let csvContent = "data:text/csv;charset=utf-8,Date,Time,EmpID,Name,Type\n";
            window.currentData.forEach(row => {
                const date = row.timestamp ? new Date(row.timestamp.seconds * 1000).toLocaleDateString('th-TH') : "-";
                const time = row.timestamp ? new Date(row.timestamp.seconds * 1000).toLocaleTimeString('th-TH') : "-";
                csvContent += `${date},${time},"${row.empId}","${row.name}",${row.type}\r\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `report_${document.getElementById('filterDate').value}.csv`);
            document.body.appendChild(link);
            link.click();
        };
    </script>
</body>
</html>