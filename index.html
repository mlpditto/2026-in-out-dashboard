<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (GPS Forced)</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: white; width: 100%; max-width: 420px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); min-height: 100vh; box-sizing: border-box; }
        .hidden { display: none !important; }
        
        /* Buttons */
        .btn { padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; color: white; transition: 0.2s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .btn-warning { background-color: #ffc107; color: black; }
        
        /* Form & Profile */
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .history-item { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 5px; border-left: 4px solid #ccc; font-size: 0.9em; display: flex; justify-content: space-between; }
        .status-pending { background-color: #fff3cd; color: #856404; padding: 30px 20px; border-radius: 10px; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container text-center">
        <div id="loadingPage" style="margin-top: 40vh;">
            <div style="font-size: 30px;">‚è≥</div>
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
        </div>

        <div id="registerPage" class="hidden">
            <h3>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <img id="regisProfileImg" src="" class="profile-img">
            <p id="regisName" style="color:#666; margin-bottom: 20px;"></p>
            <form onsubmit="handleRegister(event)">
                <input type="text" id="empId" class="form-control" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô EMP001)" required>
                <input type="text" id="fullName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏£‡∏¥‡∏á" required>
                <select id="department" class="form-control">
                    <option value="General">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    <option value="Pharmacy">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°</option>
                    <option value="IT">IT / Support</option>
                    <option value="Admin">‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</option>
                    <option value="Sales">‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î/‡∏Ç‡∏≤‡∏¢</option>
                </select>
                <button type="submit" class="btn btn-primary">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </form>
        </div>

        <div id="pendingPage" class="hidden">
            <div class="status-pending">
                <h1>‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h1>
                <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
                <img id="pendingImg" src="" class="profile-img">
                <p id="pendingName" style="font-weight:bold;"></p>
            </div>
        </div>

        <div id="mainPage" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="text-align: left;">
                    <h3 id="showName" style="margin: 0; font-size: 1.2rem;">User</h3>
                    <small id="showEmpId" style="color: gray;">ID</small>
                </div>
                <img id="mainProfileImg" src="" style="width: 50px; height: 50px; border-radius: 50%;">
            </div>
            <hr>
            
            <div id="currentDate" style="color: gray; font-size: 0.9rem;">...</div>
            <div id="clock" style="font-size: 3rem; font-weight: bold; margin: 10px 0; color: #333;">00:00:00</div>

            <button onclick="recordTime('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')" class="btn btn-success">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Clock In)</button>
            <button onclick="recordTime('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô')" class="btn btn-danger">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Clock Out)</button>
            
            <button onclick="toggleLeaveForm()" class="btn btn-warning">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î / ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>

            <div id="leaveFormSection" class="hidden" style="background: #fffbe6; padding: 15px; border-radius: 8px; margin-top: 10px; text-align: left; border: 1px solid #ffeeba;">
                <h4 style="margin-top:0;">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î</h4>
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
                <select id="leaveType" class="form-control">
                    <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                    <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à">‡∏ò‡∏∏‡∏£‡∏∞ ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                    <option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
                </select>
                <label>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label> <input type="date" id="leaveStart" class="form-control">
                <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label> <input type="date" id="leaveEnd" class="form-control">
                <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</label> <input type="text" id="leaveReason" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•...">
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="submitLeaveRequest()" class="btn btn-primary" style="margin:0;">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                    <button onclick="toggleLeaveForm()" class="btn" style="background:#ddd; color:black; margin:0;">‡∏õ‡∏¥‡∏î</button>
                </div>
                <hr>
                <strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</strong>
                <ul id="myLeaveList" style="padding-left: 0; list-style: none; margin-top: 5px;"></ul>
            </div>

            <div style="margin-top: 25px; text-align: left;">
                <strong>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</strong>
                <div id="scheduleList" style="margin-top: 5px; font-size: 0.9rem; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
            
            <div style="margin-top: 25px; text-align: left;">
                <strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</strong>
                <ul id="historyList" style="padding-left: 0; list-style: none; margin-top: 5px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, where, getDocs, serverTimestamp, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- üî¥ CONFIGURATION ZONE (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
         const firebaseConfig = {

    apiKey: "AIzaSyDEe7ndwzIXokG50MbNykyMG2Ed2bYWvEI",

    authDomain: "in-out-dashboard.firebaseapp.com",

    projectId: "in-out-dashboard",

    storageBucket: "in-out-dashboard.firebasestorage.app",

    messagingSenderId: "846266395224",

    appId: "1:846266395224:web:44d1dfe11692f33ca5f82d",

    measurementId: "G-WN14VJSG17"

  };
        const LIFF_ID = "2008951813-KgjInNxK"; 
        // ------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUser = {};

        // 1. Init
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUser = { lineUserId: profile.userId, pictureUrl: profile.pictureUrl, displayName: profile.displayName };
                checkUserInFirestore();
            } catch (err) { alert("LIFF Error: " + err); }
        }
        main();

        async function checkUserInFirestore() {
            try {
                const docRef = doc(db, "users", currentUser.lineUserId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.status === 'Pending') {
                        showPage('pendingPage');
                        document.getElementById('pendingImg').src = currentUser.pictureUrl;
                        document.getElementById('pendingName').innerText = data.name;
                    } else if (data.status === 'Approved') {
                        currentUser.name = data.name; currentUser.empId = data.empId; currentUser.dept = data.dept;
                        showMainPage();
                    } else { alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö"); }
                } else {
                    showPage('registerPage');
                    document.getElementById('regisProfileImg').src = currentUser.pictureUrl;
                    document.getElementById('regisName').innerText = currentUser.displayName;
                }
            } catch (err) { alert("Connect Error: " + err.message); }
        }

        function showPage(pageId) {
            ['loadingPage','registerPage','pendingPage','mainPage'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        window.handleRegister = async (e) => {
            e.preventDefault();
            const empId = document.getElementById('empId').value.trim();
            const fullName = document.getElementById('fullName').value.trim();
            const dept = document.getElementById('department').value;
            const btn = e.target.querySelector('button'); btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            try {
                await setDoc(doc(db, "users", currentUser.lineUserId), {
                    lineUserId: currentUser.lineUserId, pictureUrl: currentUser.pictureUrl, empId: empId, name: fullName, dept: dept,
                    status: "Pending", registeredAt: serverTimestamp()
                });
                alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"); window.location.reload();
            } catch (err) { alert("Error: " + err.message); btn.disabled = false; }
        };

        function showMainPage() {
            showPage('mainPage');
            document.getElementById('showName').innerText = currentUser.name;
            document.getElementById('showEmpId').innerText = `${currentUser.empId} | ${currentUser.dept}`;
            document.getElementById('mainProfileImg').src = currentUser.pictureUrl;
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString('th-TH');
                document.getElementById('currentDate').innerText = now.toLocaleDateString('th-TH', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
            }, 1000);
            loadTodayHistory();
            loadMySchedule();
        }

        // --- üü¢ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö GPS + ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡πÑ‡∏•‡∏ô‡πå) ---
        window.recordTime = async (type) => {
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${type}?`)) return;

            const btn = event.target;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î...";

            const saveToFirestore = async (lat, lng) => {
                try {
                    btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
                    
                    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô)
                    const locationData = { lat: lat, lng: lng };
                    const mapLink = `http://maps.google.com/?q=${lat},${lng}`;

                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Firebase
                    await addDoc(collection(db, "attendance"), {
                        userId: currentUser.lineUserId,
                        name: currentUser.name,
                        empId: currentUser.empId,
                        dept: currentUser.dept,
                        type: type,
                        timestamp: serverTimestamp(),
                        location: locationData, // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π
                        mapUrl: mapLink,        // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π
                        userAgent: navigator.userAgent
                    });

                    // ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå (‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà mapLink)
                    if (liff.isInClient()) {
                        const icon = type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'üü¢' : 'üî¥';
                        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏µ‡∏ô‡πÜ
                        const msg = `${icon} ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${type}\nüë§ ${currentUser.name}\n‚è∞ ${new Date().toLocaleTimeString('th-TH')}`;
                        await liff.sendMessages([{ type: 'text', text: msg }]).catch(e => console.log(e));
                    }

                    alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${type} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
                    loadTodayHistory();

                } catch (err) {
                    alert("Error: " + err.message);
                } finally {
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            };

            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏≠ GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // ‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î -> ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        saveToFirestore(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        console.error("GPS Error:", error);
                        // ‚õîÔ∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î -> ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ\n\n‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î 'Allow' ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                        btn.disabled = false;
                        btn.innerText = originalText;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        };

        // --- ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏±‡∏Å Error Index) ---
        async function loadTodayHistory() {
            try {
                const start = new Date(); start.setHours(0,0,0,0);
                const q = query(collection(db, "attendance"), where("userId","==",currentUser.lineUserId), where("timestamp",">=",start), orderBy("timestamp"));
                const snap = await getDocs(q);
                const list = document.getElementById('historyList'); list.innerHTML = "";
                
                if(snap.empty) { list.innerHTML = "<li style='color:#999; font-size:0.9em;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</li>"; return; }
                
                snap.forEach(d => {
                    const v = d.data();
                    const time = v.timestamp ? new Date(v.timestamp.seconds*1000).toLocaleTimeString('th-TH') : "..";
                    const color = v.type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? '#28a745' : '#dc3545';
                    list.innerHTML += `<li class="history-item" style="border-left-color:${color}"><span>${v.type}</span> <strong>${time}</strong></li>`;
                });
            } catch (err) {
                if(err.message.includes("index")) alert("‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: Database ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Index\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á Admin ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÉ‡∏ô Firebase Console");
                document.getElementById('historyList').innerHTML = `<li style="color:red; font-size:0.8em;">Error Index: ${err.message}</li>`;
            }
        }

        // --- ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏±‡∏Å Error Index) ---
        async function loadMySchedule() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const q = query(collection(db, "schedules"), where("userId","==",currentUser.lineUserId), where("date",">=",today), orderBy("date"));
                const snap = await getDocs(q);
                const div = document.getElementById('scheduleList'); div.innerHTML = "";

                if(snap.empty) { div.innerHTML = "<p class='text-muted' style='font-size:0.9em'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>"; return; }

                snap.forEach(d => {
                    const v = d.data();
                    const dThai = new Date(v.date).toLocaleDateString('th-TH', {weekday:'short', day:'numeric', month:'short'});
                    let color = '#007bff'; if(v.shiftDetail.includes('‡∏´‡∏¢‡∏∏‡∏î') || v.shiftDetail.includes('‡∏•‡∏≤')) color = '#dc3545';
                    div.innerHTML += `<div style="background:white; border-left:4px solid ${color}; padding:10px; margin-bottom:5px; box-shadow:0 1px 2px rgba(0,0,0,0.1); border-radius:4px;">
                        <div style="display:flex; justify-content:space-between;"><strong>${dThai}</strong><span style="color:${color}; font-size:0.9em;">${v.shiftDetail}</span></div></div>`;
                });
            } catch (err) {
                console.error(err);
                document.getElementById('scheduleList').innerHTML = `<p style="color:red; font-size:0.8em;">Error Index: ${err.message}</p>`;
            }
        }

        window.toggleLeaveForm = () => { const el = document.getElementById('leaveFormSection'); el.classList.toggle('hidden'); if(!el.classList.contains('hidden')) loadMyLeaves(); };
        window.submitLeaveRequest = async () => {
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('leaveStart').value;
            const end = document.getElementById('leaveEnd').value;
            const reason = document.getElementById('leaveReason').value;
            if(!start || !end) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            if(start > end) return alert("‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏ö");
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤?")) return;
            try {
                await addDoc(collection(db, "leave_requests"), {
                    userId: currentUser.lineUserId, name: currentUser.name, dept: currentUser.dept,
                    type, startDate: start, endDate: end, reason, status: "Pending", requestedAt: serverTimestamp()
                });
                if (liff.isInClient()) { await liff.sendMessages([{ type: 'text', text: `üìù ‡∏Ç‡∏≠‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î (${currentUser.name})\nüìå ${type}\nüìÖ ${start} ‡∏ñ‡∏∂‡∏á ${end}\nüí¨ ${reason||'-'}` }]).catch(e=>console.log(e)); }
                alert("‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); toggleLeaveForm();
            } catch (err) { alert("Error: " + err.message); }
        };

        async function loadMyLeaves() {
            try {
                const q = query(collection(db, "leave_requests"), where("userId","==",currentUser.lineUserId), orderBy("startDate","desc"));
                const snap = await getDocs(q);
                const list = document.getElementById('myLeaveList'); list.innerHTML = "";
                snap.forEach(d => {
                    const v = d.data();
                    let color = 'orange'; let status = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    if(v.status==='Approved') { color='green'; status='‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; }
                    if(v.status==='Rejected') { color='red'; status='‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'; }
                    list.innerHTML += `<li style="margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px; font-size:0.9em;"><span style="color:${color}; font-weight:bold;">${status}</span> : ${v.type} <span style="color:#666;">(${v.startDate})</span></li>`;
                });
            } catch(e) { console.log(e); }
        }
    </script>
</body>
</html>
