<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP Time Attendance</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0d6efd 0%, #0099ff 100%);
            --danger-gradient: linear-gradient(135deg, #dc3545 0%, #ff4d5a 100%);
            --success-gradient: linear-gradient(135deg, #198754 0%, #20c997 100%);
            --warning-gradient: linear-gradient(135deg, #ffc107 0%, #ffdb4d 100%);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --bg-color: #f0f2f5;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: white;
            width: 100%;
            max-width: 450px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            min-height: 100vh;
            box-sizing: border-box;
            position: relative;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4 {
            margin: 0;
            font-weight: 700;
            color: #2c3e50;
        }

        .text-muted {
            color: #6c757d;
        }

        /* Components */
        .hidden {
            display: none !important;
        }

        .tiny-text {
            font-size: 0.7rem !important;
        }

        .letter-spacing-1 {
            letter-spacing: 1px;
        }

        .scroller-x {
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .scroller-x::-webkit-scrollbar {
            display: none;
        }

        .shift-chip {
            transition: all 0.2s ease;
            border-width: 2px !important;
            white-space: nowrap;
        }

        .shift-chip.active {
            transform: scale(1.05);
        }

        .rounded-4 {
            border-radius: 1rem !important;
        }

        .bg-light {
            background-color: #f8f9fa !important;
        }

        .input-group-text {
            border: none !important;
        }

        input[type="date"],
        input[type="time"] {
            -webkit-appearance: none;
            min-height: 24px;
        }

        .profile-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-img {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            margin-bottom: 12px;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            object-fit: cover;
        }

        /* Buttons */
        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: 'Sarabun', sans-serif;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            filter: grayscale(100%);
        }

        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
        }

        .btn-success {
            background: var(--success-gradient);
            box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3);
        }

        .btn-danger {
            background: var(--danger-gradient);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: #444;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-outline {
            background: white;
            border: 2px solid #eee;
            color: #555;
            box-shadow: none;
        }

        /* Inputs */
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #eee;
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: 0.2s;
            font-family: 'Sarabun', sans-serif;
        }

        .form-control:focus {
            border-color: #0d6efd;
            outline: none;
            background: #fdfdfd;
        }

        /* Cards & Lists */
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 25px;
            border: 1px solid #eee;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 5px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            border: 1px solid #f0f0f0;
            border-left-width: 5px;
        }

        .history-item.in {
            border-left-color: #198754;
        }

        .history-item.out {
            border-left-color: #dc3545;
        }

        /* Time Display */
        .digital-clock {
            font-size: 3.5rem;
            font-weight: 800;
            color: #333;
            letter-spacing: -2px;
            line-height: 1;
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
        }

        .date-display {
            color: #666;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        /* Loader */
        .loader-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 80vh;
            color: #666;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Debug Console -->
        <div id="debugConsole"
            style="display:none; position:fixed; top:0; left:0; width:100%; background:rgba(0,0,0,0.9); color:lime; font-family:monospace; font-size:10px; z-index:9999; max-height:150px; overflow-y:auto; padding:5px; pointer-events:auto; border-bottom:1px solid lime;">
            <div>[System Debug Mode]</div>
        </div>

        <!-- Loading -->
        <div id="loadingPage" class="loader-container">
            <div class="spinner"></div>
            <p id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
        </div>

        <!-- Register -->
        <div id="registerPage" class="hidden text-center" style="padding-top: 20px;">
            <img src="https://via.placeholder.com/100" class="profile-img" id="regisProfileImg">
            <h3>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <p id="regisName" class="text-muted mb-4">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</p>

            <form onsubmit="handleRegister(event)" style="text-align: left;">
                <label class="small text-muted fw-bold ms-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                <input type="tel" id="userPhone" class="form-control" placeholder="08xxxxxxxx" pattern="[0-9]{9,10}"
                    required>

                <label class="small text-muted fw-bold ms-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</label>
                <input type="text" id="fullName" class="form-control" placeholder="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏ô‡∏≤‡∏¢/‡∏ô‡∏≤‡∏á/‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß)"
                    required>

                <label class="small text-muted fw-bold ms-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                <input type="text" id="department" class="form-control" list="deptOptions"
                    placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°" onchange="toggleInternshipFields()" required>
                <datalist id="deptOptions">
                    <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General)">
                    <option value="üíª IT">
                    <option value="üéì Pharmacist Extern">
                    <option value="üéì Pharmacist Intern (ex)">
                    <option value="üíä Pharmacy">
                    <option value="üí∞ Sales">
                </datalist>

                <!-- Internship Period Fields (initially hidden) -->
                <div id="internshipFields" style="display: none;">
                    <label class="small text-muted fw-bold ms-1 mt-3">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="date" id="internshipStartDate" class="form-control" min="2024-01-01">

                    <label class="small text-muted fw-bold ms-1 mt-2">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="date" id="internshipEndDate" class="form-control" min="2024-01-02">
                </div>

                <button type="submit" class="btn btn-primary mt-3">
                    <i class="bi bi-person-check-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </form>
        </div>

        <!-- Pending -->
        <div id="pendingPage" class="hidden text-center" style="padding-top: 40px;">
            <div class="status-card" style="background: #fff3cd; border-color: #ffecb5;">
                <i class="bi bi-hourglass-split text-warning" style="font-size: 3rem;"></i>
                <h2 class="mt-3 text-warning-emphasis">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
                <p class="text-muted mt-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
            </div>
            <img id="pendingImg" src="" class="profile-img" style="filter: grayscale(1);">
            <p id="pendingName" class="fw-bold mt-2"></p>
            <button onclick="window.location.reload()" class="btn btn-outline py-2 fs-6 mt-3">‚ü≥
                ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>

        <!-- Main Dashboard -->
        <div id="mainPage" class="hidden">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div style="flex:1;">
                    <h2 id="showName" class="text-truncate">User</h2>
                    <small id="showEmpId" class="text-muted">ID</small>
                </div>
                <img id="mainProfileImg" src="" class="profile-img" style="width: 55px; height: 55px; margin:0;">
            </div>

            <div class="status-card">
                <div id="currentDate" class="date-display">...</div>
                <div id="clock" class="digital-clock">00:00:00</div>
                <div id="shiftStatus" class="badge rounded-pill bg-light text-dark border px-3 py-1">‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (08:00 -
                    17:00)</div>
            </div>

            <div class="row g-2">
                <button onclick="recordTime('‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô')" class="btn btn-success hidden" id="btnCheckIn">
                    <i class="bi bi-geo-alt-fill"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Clock In)
                </button>
                <button onclick="recordTime('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô')" class="btn btn-danger hidden" id="btnCheckOut">
                    <i class="bi bi-box-arrow-right"></i> ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (Clock Out)
                </button>
            </div>

            <div id="clockInStatusMsg" class="text-center text-muted small mt-2 mb-3 hidden">
                <i class="bi bi-info-circle"></i> ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏°.)
            </div>

            <button onclick="toggleLeaveForm()" class="btn btn-warning py-3" style="font-size:1rem; opacity:0.9;">
                <i class="bi bi-file-earmark-text"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤ / ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏£ / ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            </button>

            <!-- Leave Form Modal-ish -->
            <div id="leaveFormSection" class="hidden"
                style="background: white; border-radius: 16px; border: 1px solid #eee; box-shadow: 0 5px 20px rgba(0,0,0,0.05); padding: 20px; margin-top: 15px; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; box-sizing: border-box;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>üìù ‡∏ü‡∏≠‡∏£‡πå‡∏°</h3>
                    <button onclick="toggleLeaveForm()" class="btn-close"
                        style="background:none; border:none; font-size:1.5rem;">&times;</button>
                </div>
                <!-- MODERN FORM -->
                <div id="leaveFormSection" class="p-3">
                    <div class="mb-4">
                        <label
                            class="form-label small fw-bold text-muted mb-2 text-uppercase letter-spacing-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠
                            / Request Type</label>
                        <select id="leaveType"
                            class="form-select border-0 bg-light rounded-4 py-3 shadow-sm font-weight-600"
                            onchange="toggleTimeInputs()" style="height: 56px;">
                            <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à">üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à (Personal Leave)</option>
                            <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (Sick Leave)</option>
                            <option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô">üå¥ ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (Annual Leave)</option>
                            <option value="‡∏•‡∏≤‡∏ö‡∏ß‡∏ä">üôè ‡∏•‡∏≤‡∏ö‡∏ß‡∏ä (Ordination Leave)</option>
                            <option value="‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î">üë∂ ‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î (Maternity Leave)</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">üõë ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (Others)</option>
                            <option value="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô">üïí ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (Work Schedule)</option>
                        </select>
                    </div>

                    <!-- Date Range Section -->
                    <div class="card border-0 rounded-4 bg-light shadow-none mb-3 overflow-hidden">
                        <div class="card-body p-3">
                            <label class="form-label small fw-bold text-muted mb-3 d-flex align-items-center">
                                <i class="bi bi-calendar-event me-2 text-primary"></i> ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô / Date Range
                            </label>
                            <div class="row g-2">
                                <div class="col-6 text-center">
                                    <div class="bg-white rounded-3 p-2 border">
                                        <small class="text-muted d-block tiny-text mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° / From</small>
                                        <input type="date" id="leaveStart"
                                            class="form-control border-0 p-0 text-center fw-bold"
                                            onchange="syncMinDate(); updateDaySummary();"
                                            style="background: transparent;">
                                    </div>
                                </div>
                                <div class="col-6 text-center">
                                    <div class="bg-white rounded-3 p-2 border">
                                        <small class="text-muted d-block tiny-text mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / To</small>
                                        <input type="date" id="leaveEnd"
                                            class="form-control border-0 p-0 text-center fw-bold"
                                            onchange="updateDaySummary()" style="background: transparent;">
                                    </div>
                                </div>
                            </div>
                            <div id="daySummary" class="text-center mt-2 small text-primary fw-bold hidden">
                                <i class="bi bi-info-circle"></i> ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô <span id="totalDays">0</span> ‡∏ß‡∏±‡∏ô
                            </div>
                        </div>
                    </div>

                    <!-- Work Shift Section (Visible only for Work Schedule) -->
                    <div id="timeInputGroup"
                        class="card border-0 rounded-4 bg-light shadow-none mb-3 overflow-hidden hidden"
                        style="border-left: 4px solid #198754 !important;">
                        <div class="card-body p-3">
                            <label class="form-label small fw-bold text-muted mb-3 d-flex align-items-center">
                                <i class="bi bi-clock me-2 text-success"></i> ‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô / Work Shift
                            </label>

                            <!-- Quick Shift Chips -->
                            <div class="d-flex flex-wrap gap-2 mb-3 scroller-x">
                                <button class="btn btn-outline-success btn-sm rounded-pill py-1 px-3 fw-bold shift-chip"
                                    onclick="setQuickShift('10:00','19:00', this)">10:00 - 19:00</button>
                                <button class="btn btn-outline-success btn-sm rounded-pill py-1 px-3 fw-bold shift-chip"
                                    onclick="setQuickShift('08:00','17:00', this)">08:00 - 17:00</button>
                                <button class="btn btn-outline-success btn-sm rounded-pill py-1 px-3 fw-bold shift-chip"
                                    onclick="setQuickShift('12:00','21:00', this)">12:00 - 21:00</button>
                                <button class="btn btn-outline-success btn-sm rounded-pill py-1 px-3 fw-bold shift-chip"
                                    onclick="setQuickShift('11:00','20:00', this)">11:00 - 20:00</button>
                                <button
                                    class="btn btn-outline-secondary btn-sm rounded-pill py-1 px-3 fw-bold shift-chip"
                                    onclick="setQuickShift('09:00','18:00', this)">09:00 - 18:00</button>
                            </div>

                            <div class="row g-2">
                                <div class="col-6 text-center border-end">
                                    <small class="text-muted d-block tiny-text mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏° / In</small>
                                    <input type="time" id="reqStartTime"
                                        class="form-control border-0 bg-transparent text-center p-0 fw-bold"
                                        value="10:00">
                                </div>
                                <div class="col-6 text-center">
                                    <small class="text-muted d-block tiny-text mb-1">‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô / Out</small>
                                    <input type="time" id="reqEndTime"
                                        class="form-control border-0 bg-transparent text-center p-0 fw-bold"
                                        value="19:00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reason & Link -->
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / Reason</label>
                        <textarea id="leaveReason" class="form-control border-0 bg-light rounded-4 p-3 mb-2" rows="3"
                            placeholder="‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>

                        <label class="form-label small fw-bold text-muted mb-2 d-block">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û / Attachment
                            Link</label>
                        <div class="input-group">
                            <span class="input-group-text border-0 bg-light rounded-start-4"><i
                                    class="bi bi-link-45deg"></i></span>
                            <input type="url" id="leaveLink" class="form-control border-0 bg-light rounded-end-4 py-2"
                                placeholder="https://drive.google.com/...">
                        </div>
                    </div>

                    <button onclick="submitLeaveRequest()"
                        class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-lg mb-4" id="btnSubmitLeave">
                        <i class="bi bi-send-fill me-2"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
                <ul id="myLeaveList" class="history-list" style="max-height: 200px; overflow-y: auto;"></ul>
            </div>

            <!-- Working Hours Summary -->
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2"
                    onclick="toggleSection('workingHoursContent')" style="cursor: pointer;">
                    <h4 class="text-muted m-0"><i class="bi bi-clock-history"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h4>
                    <i class="bi bi-chevron-down text-muted" id="icon-workingHoursContent"></i>
                </div>
                <!-- Collapsible Content -->
                <div id="workingHoursContent" style="display: none;">
                    <div class="row g-2">
                        <div class="col-12" id="totalHoursCard">
                            <div class="card border-primary bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1 text-primary fw-bold" id="hours1Title">
                                                ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
                                            <small class="text-muted" id="hours1Desc">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</small>
                                        </div>
                                        <div class="text-end">
                                            <h3 class="mb-0 text-primary fw-bold" id="hours1Value">0.00</h3>
                                            <small class="text-muted">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12" id="monthlyHoursCard">
                            <div class="card border-success bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1 text-success fw-bold" id="hours2Title">
                                                ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h6>
                                            <small class="text-muted" id="hours2Desc">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1
                                                ‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</small>
                                        </div>
                                        <div class="text-end">
                                            <h3 class="mb-0 text-success fw-bold" id="hours2Value">0.00</h3>
                                            <small class="text-muted">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12" id="yearlyHoursCard">
                            <div class="card border-info bg-light">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1 text-info fw-bold" id="hours3Title">
                                                ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ
                                            </h6>
                                            <small class="text-muted" id="hours3Desc">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°
                                                ‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</small>
                                        </div>
                                        <div class="text-end">
                                            <h3 class="mb-0 text-info fw-bold" id="hours3Value">0.00</h3>
                                            <small class="text-muted">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule -->
            <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-2"
                    onclick="toggleSection('scheduleContent')" style="cursor: pointer;">
                    <h4 class="text-muted m-0"><i class="bi bi-calendar-event"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h4>
                    <i class="bi bi-chevron-down text-muted" id="icon-scheduleContent"></i>
                </div>
                <div id="scheduleContent" style="display: none;">
                    <div id="scheduleList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>

            <!-- History -->
            <div class="mt-4 pb-4">
                <div class="d-flex justify-content-between align-items-center mb-2"
                    onclick="toggleSection('historyContent')" style="cursor: pointer;">
                    <h4 class="text-muted m-0"><i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h4>
                    <i class="bi bi-chevron-down text-muted" id="icon-historyContent"></i>
                </div>
                <div id="historyContent" style="display: none;">
                    <ul id="historyList" class="history-list"></ul>
                </div>
            </div>

            <div class="text-center text-muted small mt-5 mb-2" style="opacity: 0.6;">
                v3.30
            </div>
        </div>
    </div>

    <script>
        // Emergency Debugger - Runs immediately
        window.log = (msg, isError = false) => {
            console.log(msg);
            const debug = document.getElementById('debugConsole');
            if (debug) {
                if (isError) debug.style.display = 'block';
                debug.innerHTML += `<div>> ${msg}</div>`;
                debug.scrollTop = debug.scrollHeight;
            }
            const loadingText = document.getElementById('loadingText');
            if (loadingText) loadingText.innerText = msg;
        };

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            window.log('CRITICAL: ' + msg + ' (L:' + lineNo + ')', true);
            return false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            window.log('‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (DOM Ready)');
        });
    </script>


    <script type="module">
        import { getDeptCategoryColor } from './colors.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, getDocs, serverTimestamp, orderBy, limit }
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- üî¥ CONFIG (Public) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDEe7ndwzIXokG50MbNykyMG2Ed2bYWvEI",
            authDomain: "in-out-dashboard.firebaseapp.com",
            projectId: "in-out-dashboard",
            storageBucket: "in-out-dashboard.firebasestorage.app",
            messagingSenderId: "846266395224",
            appId: "1:846266395224:web:44d1dfe11692f33ca5f82d",
            measurementId: "G-WN14VJSG17"
        };
        const LIFF_ID = "2008951813-KgjInNxK";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUser = {};

        // MAIN
        async function main() {
            // --- Preview Mode for Admin ---
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('preview') === 'true') {
                window.log('üì± Preview Mode');
                document.getElementById('loadingPage').classList.add('hidden');
                document.getElementById('mainPage').classList.remove('hidden');

                // Try to get real user data from admin parent window
                let realUser = null;
                try {
                    const parentData = window.parent?.allUserData;
                    if (parentData) {
                        const users = Object.values(parentData).filter(u => u.status === 'Approved');
                        if (users.length > 0) {
                            // Pick a random approved user for preview
                            realUser = users[Math.floor(Math.random() * users.length)];
                        }
                    }
                } catch (e) { }

                if (realUser) {
                    document.getElementById('showName').textContent = realUser.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
                    document.getElementById('showEmpId').textContent = `${realUser.empId || '‚Äî'} | ${realUser.dept || 'General'}`;
                    document.getElementById('mainProfileImg').src = realUser.pictureUrl || 'https://api.dicebear.com/7.x/avataaars/svg?seed=MLP';
                } else {
                    document.getElementById('showName').textContent = '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á';
                    document.getElementById('showEmpId').textContent = 'EMP-66001 | General';
                    document.getElementById('mainProfileImg').src = 'https://api.dicebear.com/7.x/avataaars/svg?seed=MLP';
                }

                // Clock
                function updatePreviewClock() {
                    const now = new Date();
                    const el = document.getElementById('clock');
                    if (el) el.textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                    const dateEl = document.getElementById('currentDate');
                    if (dateEl) dateEl.textContent = now.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                }
                updatePreviewClock();
                setInterval(updatePreviewClock, 1000);

                // Shift
                const shiftEl = document.getElementById('shiftStatus');
                if (shiftEl) shiftEl.innerHTML = '‚òÄÔ∏è ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (08:00 - 17:00)';

                // Hours
                const h1 = document.getElementById('hours1Value');
                const h2 = document.getElementById('hours2Value');
                const h3 = document.getElementById('hours3Value');
                if (h1) h1.textContent = '1,250.50';
                if (h2) h2.textContent = '82.71';
                if (h3) h3.textContent = '310.25';

                // Schedule mock
                const schedEl = document.getElementById('scheduleList');
                if (schedEl) {
                    const today = new Date();
                    const mockSchedule = [];
                    for (let i = 0; i < 5; i++) {
                        const d = new Date(today);
                        d.setDate(d.getDate() + i);
                        const dayStr = d.toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short' });
                        const shifts = ['‚òÄÔ∏è ‡πÄ‡∏ä‡πâ‡∏≤ (08:00-17:00)', '‚òÄÔ∏è ‡πÄ‡∏ä‡πâ‡∏≤ (09:00-18:00)', 'üö´ ‡∏´‡∏¢‡∏∏‡∏î (Day Off)', 'üïõ ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á (11:00-20:00)', '‚òÄÔ∏è ‡πÄ‡∏ä‡πâ‡∏≤ (08:00-17:00)'];
                        const colors = ['#e8f5e9', '#e8f5e9', '#fff3e0', '#e3f2fd', '#e8f5e9'];
                        mockSchedule.push(`<div style="padding:10px 14px;background:${colors[i]};border-radius:10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-weight:600;font-size:13px;">${dayStr}</span>
                            <span style="font-size:12px;opacity:0.8;">${shifts[i]}</span>
                        </div>`);
                    }
                    schedEl.innerHTML = mockSchedule.join('');
                }

                // History mock
                const histEl = document.getElementById('historyList');
                if (histEl) {
                    histEl.innerHTML = `
                        <li class="history-item" style="padding:10px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;">
                            <div><span style="font-weight:600;">üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</span><br><small style="color:#888;">08:31 ‡∏ô.</small></div>
                            <small style="color:#888;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                        </li>`;
                }

                // Disable actual buttons in preview
                const btnIn = document.getElementById('btnCheckIn');
                const btnOut = document.getElementById('btnCheckOut');
                if (btnIn) { btnIn.onclick = (e) => { e.preventDefault(); alert('‚ö†Ô∏è Preview Mode: ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á'); }; }
                if (btnOut) { btnOut.onclick = (e) => { e.preventDefault(); alert('‚ö†Ô∏è Preview Mode: ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á'); }; }

                return; // Skip LIFF init
            }

            window.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LIFF...');
            try {
                // Initialize LIFF
                await liff.init({ liffId: LIFF_ID });
                window.log('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Init OK)');

                if (!liff.isLoggedIn()) {
                    window.log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE...');
                    liff.login();
                    return;
                }

                window.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå...');
                const profile = await liff.getProfile();
                currentUser = {
                    lineUserId: profile.userId,
                    pictureUrl: profile.pictureUrl,
                    displayName: profile.displayName // LINE Display Name
                };
                window.log('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì ' + currentUser.displayName);
                await checkUser();
            } catch (err) {
                window.log('LIFF ERROR: ' + err.message);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: err.message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                    confirmButtonText: '‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                }).then(() => location.reload());
            }
        }

        async function checkUser() {
            window.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
            try {
                const userRef = doc(db, "users", currentUser.lineUserId);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUser = { ...userData, ...currentUser };
                    window.log('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö ' + (userData.name || ''));

                    // Update profile info silently if changed (both picture and name)
                    const hasPicChanged = currentUser.pictureUrl && currentUser.pictureUrl !== userData.pictureUrl;
                    const hasNameChanged = currentUser.displayName && currentUser.displayName !== userData.displayName;

                    if (hasPicChanged || hasNameChanged) {
                        const upd = {};
                        if (hasPicChanged) upd.pictureUrl = currentUser.pictureUrl;
                        if (hasNameChanged) upd.displayName = currentUser.displayName;
                        upd.lastProfileUpdate = serverTimestamp();

                        updateDoc(userRef, upd).catch(err => console.error("Silent sync error:", err));

                        // Local update for immediate UI effect
                        if (hasPicChanged) userData.pictureUrl = currentUser.pictureUrl;
                        if (hasNameChanged) userData.displayName = currentUser.displayName;
                    }

                    if (userData.status === 'Pending') {
                        show('pendingPage', userData);
                    } else if (userData.status === 'Approved') {
                        show('mainPage');
                    } else {
                        Swal.fire('‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', 'error');
                    }
                } else {
                    window.log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
                    show('registerPage');
                }
            } catch (e) {
                window.log('DATABASE ERROR: ' + e.message);
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ: ' + e.message,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }



        async function show(id, data) {
            ['loadingPage', 'registerPage', 'pendingPage', 'mainPage'].forEach(p => {
                const el = document.getElementById(p);
                el.classList.add('hidden'); // Ensure class is present
                el.style.display = 'none';  // Double safety
            });

            // Update department colors when showing main page
            if (id === 'mainPage' && currentUser && currentUser.dept) {
                updateDeptUI();
            }

            const target = document.getElementById(id);
            target.classList.remove('hidden'); // Remove !important class
            target.style.display = 'block';    // Set display

            if (id === 'registerPage') {
                document.getElementById('regisProfileImg').src = `${currentUser.pictureUrl}?v=${Date.now()}`;
                document.getElementById('regisName').innerText = currentUser.displayName;
            } else if (id === 'pendingPage') {
                document.getElementById('pendingImg').src = `${currentUser.pictureUrl}?v=${Date.now()}`;
                document.getElementById('pendingName').innerText = data.name;
            } else if (id === 'mainPage') {
                const displayName = currentUser.name || currentUser.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                const empId = currentUser.empId || 'N/A';
                const dept = currentUser.dept || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';

                const nameEl = document.getElementById('showName');
                const empEl = document.getElementById('showEmpId');
                if (nameEl) nameEl.innerText = displayName;
                if (empEl) empEl.innerText = `${empId} | ${dept}`;

                // Fallback for profile picture
                const profileImg = document.getElementById('mainProfileImg');
                const finalPic = currentUser.pictureUrl || `https://via.placeholder.com/60`;

                if (profileImg) {
                    profileImg.src = finalPic + (finalPic.includes('?') ? '&' : '?') + `v=${Date.now()}`;
                    profileImg.onerror = () => { profileImg.src = `https://via.placeholder.com/60`; };
                }

                const updateClock = () => {
                    const now = new Date();
                    const clockEl = document.getElementById('clock');
                    const dateEl = document.getElementById('currentDate');
                    if (clockEl) clockEl.innerText = now.toLocaleTimeString('th-TH', { hour12: false });
                    if (dateEl) dateEl.innerText = now.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                };
                updateClock(); // Run immediately
                // Clear any existing interval to prevent duplicates if show is called multiple times
                if (window.clockInterval) clearInterval(window.clockInterval);
                window.clockInterval = setInterval(updateClock, 1000);

                loadHistory();
                loadSchedule();
                loadWorkingHours();
            }
        }

        window.toggleInternshipFields = () => {
            const dept = document.getElementById('department').value;
            const fields = document.getElementById('internshipFields');
            if (dept.includes('Extern') || dept.includes('Intern')) {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        };

        window.toggleSection = (id) => {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (!el) return;

            if (el.style.display === 'none') {
                el.style.display = 'block';
                if (icon) icon.className = 'bi bi-chevron-up text-muted';
            } else {
                el.style.display = 'none';
                if (icon) icon.className = 'bi bi-chevron-down text-muted';
            }
        };

        // --- üü¢ REGISTRATION ---
        window.handleRegister = async (event) => {
            event.preventDefault();

            const empId = document.getElementById('userPhone').value;
            const fullName = document.getElementById('fullName').value;
            const department = document.getElementById('department').value;

            // Validate internship dates if Pharmacist Extern or Intern
            const isStudent = department.includes('Extern') || department.includes('Intern');
            if (isStudent) {
                const startDate = document.getElementById('internshipStartDate').valueAsDate;
                const endDate = document.getElementById('internshipEndDate').valueAsDate;

                if (!startDate || !endDate) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                    return;
                }

                if (endDate <= startDate) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
                    return;
                }
            }

            try {
                // Save user data with registration timestamp
                await setDoc(doc(db, "users", currentUser.lineUserId), {
                    lineUserId: currentUser.lineUserId,
                    pictureUrl: currentUser.pictureUrl,
                    displayName: currentUser.displayName,
                    empId: empId,
                    name: fullName,
                    dept: department,
                    status: 'Pending',
                    registrationDate: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    ...(isStudent && {
                        internshipStartDate: document.getElementById('internshipStartDate').valueAsDate,
                        internshipEndDate: document.getElementById('internshipEndDate').valueAsDate
                    })
                });

                // Show pending page
                show('pendingPage', { name: fullName });

            } catch (error) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        };

        // --- üü¢ CORE LOGIC: Record Time ---
        window.recordTime = async (type) => {
            // ... (keep existing recordTime logic but remove the duplicate checks inside since buttons are hidden?)
            // Actually, keep server-side checks for safety, but UI will hide button.
            const result = await Swal.fire({
                title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${type}?`,
                text: type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏π‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!" : "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡∏±‡∏ö",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? '#198754' : '#dc3545',
                confirmButtonText: `‡πÉ‡∏ä‡πà, ${type}`,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;

            const btn = type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? document.getElementById('btnCheckIn') : document.getElementById('btnCheckOut');
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            try {
                // GPS Force
                if (!navigator.geolocation) throw new Error("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    await save(type, pos.coords.latitude, pos.coords.longitude);
                }, (err) => {
                    Swal.fire({ title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS', icon: 'warning' });
                    btn.disabled = false; btn.innerHTML = originalText;
                }, { enableHighAccuracy: true });

            } catch (err) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', err.message, 'warning');
                btn.disabled = false; btn.innerHTML = originalText;
            }

            async function save(type, lat, lng, isAuto = false) {
                try {
                    btn.innerHTML = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

                    let lateReason = "";
                    let isLate = false;
                    let delayMin = 0;

                    // üïí LATE DETECTION LOGIC (Only for Clock-In)
                    if (type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' && !isAuto) {
                        const todayStr = new Date().toLocaleDateString('sv');
                        const schedSnap = await getDocs(query(collection(db, "schedules"),
                            where("userId", "==", currentUser.lineUserId),
                            where("date", "==", todayStr)));

                        if (!schedSnap.empty) {
                            const schedData = schedSnap.docs[0].data();
                            const shiftDetail = schedData.shiftDetail || "";
                            // Match HH:mm from shiftDetail (e.g., ‚è∞ 10:00 - 19:00)
                            const timeMatch = shiftDetail.match(/(\d{1,2}):(\d{2})/);

                            if (timeMatch) {
                                const schedHour = parseInt(timeMatch[1]);
                                const schedMin = parseInt(timeMatch[2]);

                                const now = new Date();
                                const schedTime = new Date(now);
                                schedTime.setHours(schedHour, schedMin, 0, 0);

                                // Grace period: 5 minutes
                                if (now > new Date(schedTime.getTime() + 5 * 60000)) {
                                    isLate = true;
                                    delayMin = Math.round((now - schedTime) / 60000);

                                    const { value: reason } = await Swal.fire({
                                        title: '‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
                                        text: `‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° ${timeMatch[0]} ‡∏ô. (‡∏™‡∏≤‡∏¢ ${delayMin} ‡∏ô‡∏≤‡∏ó‡∏µ)`,
                                        input: 'textarea',
                                        inputLabel: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏™‡∏≤‡∏¢',
                                        inputPlaceholder: '‡∏ï‡∏¥‡∏î‡∏ù‡∏ô / ‡∏£‡∏ñ‡∏ï‡∏¥‡∏î / ‡∏ò‡∏∏‡∏£‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß...',
                                        icon: 'warning',
                                        allowOutsideClick: false,
                                        inputValidator: (value) => {
                                            if (!value) return '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡∏ö'
                                        }
                                    });
                                    lateReason = reason || "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•";
                                }
                            }
                        }
                    }

                    await addDoc(collection(db, "attendance"), {
                        userId: currentUser.lineUserId, lineUserId: currentUser.lineUserId, pictureUrl: currentUser.pictureUrl, name: currentUser.name, empId: currentUser.empId, dept: currentUser.dept,
                        type: type, timestamp: serverTimestamp(),
                        location: { lat, lng }, mapUrl: `http://maps.google.com/?q=${lat},${lng}`, userAgent: navigator.userAgent,
                        isLate: isLate,
                        lateReason: lateReason,
                        delayMin: delayMin
                    });

                    if (liff.isInClient()) {
                        liff.sendMessages([{ type: 'text', text: `${type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'üü¢' : 'üî¥'} ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${type}\n‡πÇ‡∏î‡∏¢: ${currentUser.name}\n‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}` }]).catch(e => console.error(e));
                    }
                    if (!isAuto) {
                        if (type === '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô') {
                            Swal.fire({
                                title: '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!',
                                html: '<div class="mb-2">‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</div><div style="font-size:1.8rem; font-weight:bold; color:#ff6b6b;">Îòê ÎßåÎÇòÏöî</div><div class="text-muted small mt-1">(‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö)</div>',
                                icon: 'success',
                                confirmButtonText: '‡∏õ‡∏¥‡∏î'
                            });
                        } else {
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${type} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
                        }
                    }
                    loadHistory(); // Reload to toggle buttons
                    loadWorkingHours(); // Reload working hours
                } catch (e) { Swal.fire('Error', e.message, 'error'); }
                finally { btn.disabled = false; btn.innerHTML = originalText; }
            }
        };

        async function loadHistory() {
            const now = new Date();
            const todayStr = now.toLocaleDateString('sv');
            const start = new Date(); start.setHours(0, 0, 0, 0);

            // 1. Check for schedule today (Option 2: Hard Block)
            const schedQuery = query(collection(db, "schedules"),
                where("userId", "==", currentUser.lineUserId),
                where("date", "==", todayStr));
            const schedSnap = await getDocs(schedQuery);
            const hasSchedule = !schedSnap.empty;

            const q = query(collection(db, "attendance"), where("userId", "==", currentUser.lineUserId), where("timestamp", ">=", start), orderBy("timestamp"));
            const snap = await getDocs(q);

            // üü° SMART BUTTONS LOGIC
            const logs = snap.docs.map(d => d.data());
            const btnIn = document.getElementById('btnCheckIn');
            const btnOut = document.getElementById('btnCheckOut');
            const statusMsg = document.getElementById('clockInStatusMsg');

            if (!hasSchedule) {
                // BLOCK CLOCKING IF NO SCHEDULE
                btnIn.classList.add('hidden');
                btnOut.classList.add('hidden');
                if (statusMsg) {
                    statusMsg.classList.remove('hidden');
                    statusMsg.innerHTML = `<div class="p-3 bg-warning bg-opacity-10 border border-warning rounded-3 text-start mb-1">
                        <div class="fw-bold text-warning-emphasis mb-1"><i class="bi bi-exclamation-triangle-fill"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏£‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        <div class="small text-muted mb-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö</div>
                        <button onclick="toggleLeaveForm(); document.getElementById('leaveType').value='‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô'; toggleTimeInputs();" 
                                class="btn btn-warning btn-sm w-100 py-2 fw-bold" style="font-size:0.85rem; border-radius:8px;">
                            <i class="bi bi-calendar-plus"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
                        </button>
                    </div>`;
                }
            } else {
                // PROCEED WITH NORMAL IN/OUT LOGIC
                let lastType = null;
                let lastTimestamp = null;
                if (logs.length > 0) {
                    const lastLog = logs[logs.length - 1];
                    lastType = lastLog.type;
                    lastTimestamp = lastLog.timestamp ? lastLog.timestamp.toDate() : new Date();
                }

                if (lastType === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô') {
                    btnIn.classList.add('hidden');
                    const diffMs = now - lastTimestamp;
                    const diffHours = diffMs / (1000 * 60 * 60);

                    if (diffHours >= 1) {
                        btnOut.classList.remove('hidden');
                        if (statusMsg) statusMsg.classList.add('hidden');
                    } else {
                        btnOut.classList.add('hidden');
                        if (statusMsg) {
                            statusMsg.classList.remove('hidden');
                            statusMsg.innerHTML = `<i class="bi bi-hourglass-split"></i> ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ${lastTimestamp.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })} (‡∏£‡∏≠ 1 ‡∏ä‡∏°. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô)`;
                        }
                    }

                    if (now.getHours() >= 23) {
                        await performAutoCheckout();
                        return;
                    }
                } else {
                    btnIn.classList.remove('hidden');
                    btnOut.classList.add('hidden');
                    if (statusMsg) statusMsg.classList.add('hidden');
                }
            }

            // Render List
            const list = document.getElementById('historyList'); list.innerHTML = "";
            if (snap.empty) { list.innerHTML = "<p class='text-muted text-center small'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>"; return; }
            snap.forEach(d => {
                const v = d.data();
                const time = v.timestamp ? new Date(v.timestamp.seconds * 1000).toLocaleTimeString('th-TH', { hour12: false }) : "..";
                const icon = v.type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'bi-geo-alt-fill text-success' : 'bi-box-arrow-right text-danger';
                list.innerHTML += `<li class="history-item ${v.type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' ? 'in' : 'out'}">
                    <div class="d-flex align-items-center gap-2"><i class="bi ${icon}"></i> <span class="fw-bold">${v.type}</span></div>
                    <span class="mono-font badge bg-light text-dark border">${time} ‡∏ô.</span>
                </li>`;
            });
        }

        async function performAutoCheckout() {
            Swal.fire({
                title: '‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤ 23:00 ‡∏ô.',
                text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô" ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Timestamp 23:00)',
                icon: 'info',
                timer: 4000
            });

            // Calculate timestamp for Today 23:00:00
            const autoTime = new Date();
            autoTime.setHours(23, 0, 0, 0);

            // Get location if possible, else 0,0
            let lat = 0, lng = 0;
            try {
                const pos = await new Promise((res, rej) => {
                    navigator.geolocation.getCurrentPosition(res, rej, { timeout: 3000 });
                });
                lat = pos.coords.latitude; lng = pos.coords.longitude;
            } catch (e) { console.log('Auto-checkout GPS failed, using default'); }

            try {
                await addDoc(collection(db, "attendance"), {
                    userId: currentUser.lineUserId, lineUserId: currentUser.lineUserId, pictureUrl: currentUser.pictureUrl, name: currentUser.name, empId: currentUser.empId, dept: currentUser.dept,
                    type: '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô',
                    timestamp: autoTime, // Force 23:00
                    location: { lat, lng }, mapUrl: `http://maps.google.com/?q=${lat},${lng}`,
                    userAgent: 'Evaluate-System (Auto 23:00)'
                });
                loadHistory(); // Reload UI
            } catch (e) { console.error("Auto Checkout Err", e); }
        }

        async function loadSchedule() {
            // ... (rest same) ...
            // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£ (logic ‡πÄ‡∏î‡∏¥‡∏° + UI ‡πÉ‡∏´‡∏°‡πà)
            const today = new Date().toISOString().split('T')[0];
            const q = query(collection(db, "schedules"), where("userId", "==", currentUser.lineUserId), where("date", ">=", today));
            const snap = await getDocs(q);
            const div = document.getElementById('scheduleList');
            const statusEl = document.getElementById('shiftStatus');

            if (snap.empty) {
                div.innerHTML = "<p class='text-muted text-center small'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>";
                if (statusEl) {
                    statusEl.innerText = "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏£";
                    statusEl.className = "badge rounded-pill bg-light text-muted border px-3 py-1";
                }
                return;
            }

            const docs = snap.docs.map(doc => doc.data()).sort((a, b) => a.date.localeCompare(b.date));
            div.innerHTML = "";
            docs.forEach(v => {
                const dThai = new Date(v.date).toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short' });
                let badgeClass = "bg-primary-subtle text-primary";
                if (v.shiftDetail.includes('‡∏´‡∏¢‡∏∏‡∏î') || v.shiftDetail.includes('‡∏•‡∏≤')) badgeClass = "bg-danger-subtle text-danger";
                else if (v.shiftDetail.includes('‡∏î‡∏∂‡∏Å')) badgeClass = "bg-dark-subtle text-dark";

                // Clean emojis to prevent duplicates like ü§íüõë
                const cleanDetail = v.shiftDetail.replace(/ü§í|üå¥|üìã|üë∂|üôè|üõë|üö´|üèñÔ∏è|üíº|‚è∞|‚òÄÔ∏è|üïõ|üïô|‚öôÔ∏è/g, '').trim();
                let emoji = '';
                const lLower = v.shiftDetail.toLowerCase();
                if (lLower.includes('‡∏õ‡πà‡∏ß‡∏¢')) emoji = 'ü§í';
                else if (lLower.includes('‡∏û‡∏±‡∏Å')) emoji = 'üå¥';
                else if (lLower.includes('‡∏Å‡∏¥‡∏à')) emoji = 'üìã';
                else if (lLower.includes('‡∏´‡∏¢‡∏∏‡∏î')) emoji = 'üõë';

                const displayDetail = emoji ? `${emoji} ${cleanDetail}` : v.shiftDetail;

                div.innerHTML += `<div class="d-flex justify-content-between align-items-center p-3 mb-2 bg-white rounded border border-light shadow-sm">
                    <div class="fw-bold text-secondary"><i class="bi bi-calendar-day me-2"></i>${dThai}</div>
                    <span class="badge ${badgeClass} border">${displayDetail}</span>
                </div>`;
            });

            // Update Shift Status Badge current day
            const todaySched = snap.docs.find(d => d.data().date === today);
            if (todaySched) {
                statusEl.innerText = todaySched.data().shiftDetail;
                statusEl.className = "badge rounded-pill px-3 py-1 border " + (todaySched.data().shiftDetail.includes('‡∏´‡∏¢‡∏∏‡∏î') ? "bg-danger text-white" : "bg-success text-white");
            } else {
                statusEl.innerText = "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏£";
                statusEl.className = "badge rounded-pill bg-light text-muted border px-3 py-1";
            }
        }

        window.toggleLeaveForm = () => {
            const el = document.getElementById('leaveFormSection');
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) loadMyLeaves();
        }

        window.toggleTimeInputs = () => {
            const type = document.getElementById('leaveType').value;
            const group = document.getElementById('timeInputGroup');
            if (type === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô') group.classList.remove('hidden'); else group.classList.add('hidden');
        };

        window.setQuickShift = (start, end, btn) => {
            document.getElementById('reqStartTime').value = start;
            document.getElementById('reqEndTime').value = end;

            // UI feedback for chips
            document.querySelectorAll('.shift-chip').forEach(c => c.classList.remove('active', 'btn-success'));
            document.querySelectorAll('.shift-chip').forEach(c => c.classList.add('btn-outline-success'));

            btn.classList.remove('btn-outline-success');
            btn.classList.add('btn-success', 'active');
        };

        window.syncMinDate = () => {
            const start = document.getElementById('leaveStart').value;
            const endInput = document.getElementById('leaveEnd');
            endInput.min = start;
            if (endInput.value && endInput.value < start) endInput.value = start;
        };

        window.updateDaySummary = () => {
            const startStr = document.getElementById('leaveStart').value;
            const endStr = document.getElementById('leaveEnd').value;
            const summaryDiv = document.getElementById('daySummary');

            if (startStr && endStr) {
                const s = new Date(startStr);
                const e = new Date(endStr);
                const diffTime = Math.abs(e - s);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                if (diffDays > 0) {
                    document.getElementById('totalDays').innerText = diffDays;
                    summaryDiv.classList.remove('hidden');
                } else summaryDiv.classList.add('hidden');
            } else summaryDiv.classList.add('hidden');
        };

        window.submitLeaveRequest = async () => {
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('leaveStart').value;
            const end = document.getElementById('leaveEnd').value;
            const reason = document.getElementById('leaveReason').value;
            const attachLink = document.getElementById('leaveLink').value;

            const startTime = document.getElementById('reqStartTime').value;
            const endTime = document.getElementById('reqEndTime').value;

            if (!start || !end) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
            if (start > end) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏à‡∏ö', 'warning');

            let finalReason = reason || "";
            const isWorkSchedule = (type === '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô');
            if (isWorkSchedule) {
                if (!startTime || !endTime) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏á‡∏≤‡∏ô', 'warning');
                if (startTime >= endTime) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô', 'warning');
                finalReason = `[‡∏•‡∏á‡πÄ‡∏ß‡∏£ ${startTime} - ${endTime}] ${reason || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)'}`;
            } else {
                // For Leave requests, reason might be more important, but let's keep it optional if needed
                if (!reason && type !== '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ') finalReason = `‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï${type}`;
            }

            try {
                // Auto-Approve logic for Work Schedule
                const currentStatus = isWorkSchedule ? "Approved" : "Pending";

                await addDoc(collection(db, "leave_requests"), {
                    userId: currentUser.lineUserId, name: currentUser.name, dept: currentUser.dept,
                    type, startDate: start, endDate: end, reason: finalReason,
                    attachLink, status: currentStatus, requestedAt: serverTimestamp(),
                    ...(startTime && endTime ? { reqStartTime: startTime, reqEndTime: endTime } : {})
                });

                if (isWorkSchedule) {
                    let c = new Date(start), finish = new Date(end);
                    const shiftDetail = `‚è∞ ${startTime} - ${endTime}`;
                    const batchPromises = [];

                    while (c <= finish) {
                        let ds = c.toLocaleDateString('sv');
                        batchPromises.push(setDoc(doc(db, "schedules", `${currentUser.lineUserId}_${ds}`), {
                            userId: currentUser.lineUserId, name: currentUser.name, date: ds, shiftDetail: shiftDetail,
                            reason: finalReason, attachLink: attachLink || '', timestamp: serverTimestamp()
                        }));
                        c.setDate(c.getDate() + 1);
                    }
                    await Promise.all(batchPromises);
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)', 'success');
                } else {
                    Swal.fire('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
                }

                toggleLeaveForm();
                loadSchedule();
                loadHistory(); // Re-check buttons after shift is added
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        }

        async function loadMyLeaves() {
            try {
                const q = query(collection(db, "leave_requests"), where("userId", "==", currentUser.lineUserId));
                const snap = await getDocs(q);
                const list = document.getElementById('myLeaveList');
                if (!list) return;
                list.innerHTML = "";

                if (snap.empty) {
                    list.innerHTML = "<p class='text-muted text-center small'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>";
                    return;
                }

                const docs = snap.docs.map(doc => doc.data()).sort((a, b) => {
                    const startA = a.startDate || "";
                    const startB = b.startDate || "";
                    return startB.localeCompare(startA);
                });

                docs.forEach(v => {
                    let color = 'text-warning', icon = 'bi-hourglass-split';
                    if (v.status === 'Approved') { color = 'text-success'; icon = 'bi-check-circle-fill'; }
                    if (v.status === 'Rejected') { color = 'text-danger'; icon = 'bi-x-circle-fill'; }
                    const dColor = getDeptCategoryColor(currentUser.dept);
                    list.innerHTML += `<li class="history-item py-2 px-0 border-0 shadow-none d-flex justify-content-between mb-1">
                    <div><span class="badge small border me-2" style="background:${dColor}20; color:${dColor}; border-color:${dColor}">${v.type}</span> <small class="text-muted">${v.startDate}</small></div>
                    <div class="${color} fw-bold small"><i class="bi ${icon}"></i> ${v.status}</div>
                 </li>`
                });
            } catch (err) {
                console.error("Error loading my leaves:", err);
            }
        }

        // --- DEPARTMENT COLORS ---


        function updateDeptUI() {
            if (!currentUser || !currentUser.dept) return;
            const color = getDeptCategoryColor(currentUser.dept);

            // Apply custom color to profile elements
            const elements = ['showName', 'showEmpId'];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.backgroundColor = color;
                    el.style.color = 'white';
                }
            });

            const profileImg = document.getElementById('mainProfileImg');
            if (profileImg) {
                profileImg.style.borderColor = color;
            }
        }


        // --- WORKING HOURS CALCULATION ---
        async function loadWorkingHours() {
            try {
                const dept = currentUser.dept || '';
                const isPharmacistExtern = dept === 'Pharmacist Extern' || dept.includes('Intern');

                const yearlyCard = document.getElementById('yearlyHoursCard');
                const monthlyCard = document.getElementById('monthlyHoursCard');

                // Always calculate all 3 if cards exist
                await calculateInternshipHours();
                await calculateHoursFromMonthStart();
                await calculateHoursFromYearStart();

                // Custom UI adjustments based on dept
                if (isPharmacistExtern) {
                    if (yearlyCard) yearlyCard.style.display = 'none';
                    const h1Title = document.getElementById('hours1Title');
                    const h1Desc = document.getElementById('hours1Desc');
                    if (h1Title) h1Title.innerText = '‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                    if (h1Desc) h1Desc.innerText = '‡∏ï‡∏•‡∏≠‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô';
                } else {
                    if (yearlyCard) yearlyCard.style.display = 'block';
                    const h1Title = document.getElementById('hours1Title');
                    const h1Desc = document.getElementById('hours1Desc');
                    if (h1Title) h1Title.innerText = '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
                    if (h1Desc) h1Desc.innerText = '‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
                }

            } catch (error) {
                console.error('Error loading working hours:', error);
            }
        }

        async function calculateInternshipHours() {
            try {
                // Get user data including internship period
                const userDoc = await getDoc(doc(db, "users", currentUser.lineUserId));
                if (!userDoc.exists()) return;

                const userData = userDoc.data();

                // Use internship period if available, otherwise fall back to registration date
                let startDate, endDate;

                if (userData.internshipStartDate && userData.internshipEndDate) {
                    startDate = userData.internshipStartDate.toDate ?
                        userData.internshipStartDate.toDate() :
                        new Date(userData.internshipStartDate);

                    endDate = userData.internshipEndDate.toDate ?
                        userData.internshipEndDate.toDate() :
                        new Date(userData.internshipEndDate);

                    // If end date is in the future, use yesterday as end date
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(23, 59, 59, 999);

                    if (endDate > yesterday) {
                        endDate = yesterday;
                    }
                } else {
                    // Fallback to registration date if no internship period is set
                    const registrationDate = userData.registrationDate || userData.createdAt;
                    if (!registrationDate) {
                        document.getElementById('hours1Value').innerText = '0.00';
                        return;
                    }
                    startDate = registrationDate.toDate ?
                        registrationDate.toDate() :
                        new Date(registrationDate);
                    endDate = new Date(); // Include today
                }

                const hours = await calculateWorkingHours(startDate, endDate);
                document.getElementById('hours1Value').innerText = hours.toFixed(2);

            } catch (error) {
                console.error('Error calculating internship hours:', error);
                document.getElementById('hours1Value').innerText = '0.00';
            }
        }

        async function calculateHoursFromMonthStart() {
            try {
                const now = new Date();
                const startDate = new Date(now.getFullYear(), now.getMonth(), 1); // 1st of current month
                const endDate = now; // Include today

                const hours = await calculateWorkingHours(startDate, endDate);
                document.getElementById('hours2Value').innerText = hours.toFixed(2);

            } catch (error) {
                console.error('Error calculating hours from month start:', error);
                document.getElementById('hours2Value').innerText = '0.00';
            }
        }

        async function calculateHoursFromYearStart() {
            try {
                const now = new Date();
                const startDate = new Date(now.getFullYear(), 0, 1); // 1st January
                const endDate = now; // Include today

                const hours = await calculateWorkingHours(startDate, endDate);
                document.getElementById('hours3Value').innerText = hours.toFixed(2);

            } catch (error) {
                console.error('Error calculating hours from year start:', error);
                document.getElementById('hours3Value').innerText = '0.00';
            }
        }

        async function calculateWorkingHours(startDate, endDate) {
            try {
                const q = query(
                    collection(db, "attendance"),
                    where("userId", "==", currentUser.lineUserId),
                    where("timestamp", ">=", startDate),
                    where("timestamp", "<=", endDate),
                    orderBy("timestamp")
                );

                const snap = await getDocs(q);
                const records = snap.docs.map(doc => ({
                    ...doc.data(),
                    timestamp: doc.data().timestamp.toDate()
                }));

                // Group records by date and calculate daily hours
                const dailyRecords = {};
                records.forEach(record => {
                    const dateKey = record.timestamp.toISOString().split('T')[0];
                    if (!dailyRecords[dateKey]) {
                        dailyRecords[dateKey] = [];
                    }
                    dailyRecords[dateKey].push(record);
                });

                let totalHours = 0;

                Object.values(dailyRecords).forEach(dayRecords => {
                    // Sort by time
                    dayRecords.sort((a, b) => a.timestamp - b.timestamp);

                    let dayHours = 0;
                    let clockInTime = null;

                    dayRecords.forEach(record => {
                        if (record.type === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô') {
                            clockInTime = record.timestamp;
                        } else if (record.type === '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô' && clockInTime) {
                            // Calculate hours between clock in and clock out
                            const diffMs = record.timestamp - clockInTime;
                            const diffHours = diffMs / (1000 * 60 * 60);
                            dayHours += diffHours;
                            clockInTime = null;
                        }
                    });

                    // Handle case where clocked in but no clock out
                    if (clockInTime) {
                        const now = new Date();
                        const isToday = clockInTime.toDateString() === now.toDateString();
                        const endTime = isToday ? now : new Date(clockInTime).setHours(23, 0, 0, 0);

                        const diffMs = endTime - clockInTime;
                        const diffHours = diffMs / (1000 * 60 * 60);
                        dayHours += Math.max(0, diffHours);
                    }

                    totalHours += dayHours;
                });

                return totalHours;

            } catch (error) {
                console.error('Error in calculateWorkingHours:', error);
                return 0;
            }
        }
        // Start the application when both DOM and Module are ready
        window.log('Module Loaded');
        main();
    </script>
</body>

</html>